cette application va a terme remplacer symfony-app,
on pr√©pare tout puis on bascule
la bdd sera postgresql
DOCUMENTATION COMPL√àTE DU SYST√àME MTF BITMART
1. Objectif g√©n√©ral

Le syst√®me a pour but de surveiller les march√©s √† terme (Futures) de BitMart via une analyse multi-timeframe (MTF) automatis√©e, afin de valider des setups et d√©clencher des ordres de trading selon une logique s√©quentielle :
4h ‚Üí 1h ‚Üí 15m ‚Üí 5m ‚Üí 1m.

Il doit :

Charger les donn√©es historiques (REST API) ;

√âcouter les flux en temps r√©el (WebSocket) ;

Calculer les indicateurs ;

G√©rer le cache de validation ;

Orchestrer le tout via Temporal ;

Ex√©cuter les ordres sur l‚ÄôAPI priv√©e ;

Respecter les quotas API et assurer la reprise apr√®s panne.

2. Architecture g√©n√©rale
2.1 Sch√©ma logique
Temporal (Schedule minute)
       ‚îÇ
       ‚ñº
   MtfMinuteWorkflow
       ‚îÇ
       ‚îú‚îÄ V√©rif 4h (REST)
       ‚îú‚îÄ V√©rif 1h (REST)
       ‚îú‚îÄ V√©rif 15m (REST)
       ‚îú‚îÄ Si valid√© ‚Üí attente WS
       ‚îî‚îÄ Sur 1m/5m (WS) ‚Üí d√©cision ‚Üí ordre (REST priv√©)

2.2 Domaines principaux

Domain : logique m√©tier pure (validation, signaux, indicateurs, r√®gles MTF)

Application : workflows, handlers, orchestrations

Infrastructure : adaptateurs BitMart REST/WS, persistence, cache, logs

Presentation : CLI et contr√¥leurs de supervision

3. Flux fonctionnels
3.1 Initialisation

R√©cup√©ration de tous les klines 4h et 1h via :

GET https://api-cloud-v2.bitmart.com/contract/public/kline?symbol=BTCUSDT&step=240
GET https://api-cloud-v2.bitmart.com/contract/public/kline?symbol=BTCUSDT&step=60


Les bougies sont stock√©es dans klines.

Calcul des indicateurs ‚Üí stockage dans indicator_snapshots.

G√©n√©ration de signaux (signals).

Cache de validation mis √† jour (validation_cache).

3.2 Cycle p√©riodique (chaque minute)

V√©rifier 4h : si cache expir√© ‚Üí fetch REST ‚Üí combler les trous ‚Üí recalculer ‚Üí valider.

V√©rifier 1h : m√™me logique.

V√©rifier 15m : fetch + calcul + validation.

Si 4h, 1h, 15m = valid√©s ‚Üí √©tat ‚Äúex√©cution‚Äù.

Abonnement WS (1m / 5m) ‚Üí √©coute continue.

Sur cl√¥ture : recalcul indicateurs ; si conditions OK ‚Üí envoi d‚Äôordre.

3.3 Ex√©cution (1m / 5m)

Flux :

{"action":"subscribe","args":["futures/klineBin1m:BTCUSDT"]}
{"action":"subscribe","args":["futures/klineBin5m:BTCUSDT"]}


Calcul micro-signaux.

Si alignement MTF et filtres respect√©s :

POST https://api-cloud-v2.bitmart.com/contract/private/submit-order


(params : symbol, side, type, leverage, open_type, size, etc.)

4. Authentification et signatures
4.1 REST (priv√©)

En-t√™tes requis :

X-BM-KEY: <api_key>
X-BM-TIMESTAMP: <milliseconds>
X-BM-SIGN: <signature>


Signature HMAC-SHA256 sur la concat√©nation :
timestamp + endpoint + body
avec la cl√© secr√®te.

4.2 WebSocket (priv√©)

Authentification :

{"op":"login","args":["<api_key>", "<timestamp>", "<signature>"]}


Apr√®s succ√®s :

{"action":"subscribe","args":["futures/order"]}
{"action":"subscribe","args":["futures/position"]}
{"action":"subscribe","args":["futures/asset:USDT"]}

5. URLs BitMart officielles (Futures V2)
Fonction	M√©thode	URL
Klines publics	GET	https://api-cloud-v2.bitmart.com/contract/public/kline
Passer ordre	POST	https://api-cloud-v2.bitmart.com/contract/private/submit-order
Annuler ordre	POST	/contract/private/cancel-order
Batch annulation	POST	/contract/private/cancel-orders
Positions	GET	/contract/private/position
D√©tails assets	GET	/contract/private/assets-detail
Levier	POST	/contract/private/submit-leverage
TP/SL	POST	/contract/private/submit-tp-sl-order
WS public	wss://ws-manager-compress.bitmart.com/api?protocol=1.1
WS priv√©	wss://ws-manager-compress.bitmart.com/api?protocol=1.1

R√©f√©rence compl√®te : https://developer-pro.bitmart.com/en/futuresv2/

6. Rate limit et throttling

5 req/s par IP (REST).

Politique locale : token bucket partag√© :

capacit√© = 5 tokens ;

refill = 1 token chaque 200 ms ;

1 token = 1 requ√™te.

Workers parall√©lisent les t√¢ches CPU mais utilisent un m√™me bucket centralis√© (via Redis ou process singleton).

7. Orchestration (Temporal)

Workflow : MtfMinuteWorkflow

Cadence : toutes les minutes.

OverlapPolicy : SKIP ; si un run N est en retard, le N+1 ne d√©marre pas.

Activities :

FillGapsActivity ‚Üí 4h/1h/15m.

BuildSignalsActivity ‚Üí indicateurs + signaux.

ValidateMtfActivity ‚Üí r√®gles/filtres.

8. WebSocket ‚Äì gestion des connexions

Connexions publiques : une par ~50 symboles.

PING toutes les 25 s ; reconnexion apr√®s 3 timeouts.

Message :

{"action":"subscribe","args":["futures/klineBin1m:BTCUSDT"]}


Messages re√ßus :

{
  "table": "futures/klineBin1m",
  "data": [
    {
      "symbol": "BTCUSDT",
      "open_time": 1730002200000,
      "open": "65950.2",
      "close": "65970.4",
      "high": "65980.0",
      "low": "65940.1",
      "volume": "10.5"
    }
  ]
}

9. Alignement et idempotence

Timestamps normalis√©s UTC.

Alignement bougies sur multiples de TF (00:00, 01:00, 01:15‚Ä¶).

UPSERT SQL :

INSERT INTO klines (...) VALUES (...)
ON CONFLICT (symbol, timeframe, open_time)
DO UPDATE SET close_price=EXCLUDED.close_price, volume=EXCLUDED.volume;

10. DTO et structure de donn√©es
DTO	Champs principaux
KlineDto	symbol, timeframe, open_time, open, high, low, close, volume
IndicatorSnapshotDto	ema20, ema50, macd, atr, rsi, vwap
SignalDto	side, score, trigger, meta
ValidationStateDto	status, klineTime, expires_at
OrderPlanDto	side, leverage, sl, tp, context

Tous les DTO sont s√©rialisables JSON.

11. Validation MTF & filtres

Filtres appliqu√©s avant ouverture position :

RSI < 70 ;

Distance prix‚ÄìMA21 ‚â§ 2 √ó ATR ;

Pullback confirm√© (MA9/21 ou VWAP) ;

Scaling progressif (pas entr√©e pleine taille) ;

MACD / RSI divergences invalidantes.

12. Erreurs & retries
Type	Comportement
HTTP 429	backoff exponentiel 2s‚Äì32s
Timeout	3 retries max ; journalis√©
Auth fail	reset cl√© + alerte
WebSocket drop	reconnexion + rattrapage REST
13. Observabilit√© et audit

Tables :

mtf_audit ‚Üí trace chaque √©tape et d√©cision.

order_plan ‚Üí traces d‚Äôordres planifi√©s/ex√©cut√©s.
Logs enrichis (run_id, tf, symbol, dur√©e, score).

Requ√™tes utiles :

SELECT * FROM mtf_audit WHERE symbol='BTCUSDT' ORDER BY created_at DESC LIMIT 20;
SELECT COUNT(*) FROM validation_cache WHERE expires_at<NOW();

14. S√©curit√© & gestion des secrets

Cl√©s API stock√©es via vault/.env.local non versionn√©.

Rotation manuelle tous les 90 jours.

Isolation : une cl√© par environnement (dev/staging/prod).

Mode hedge/one-way configurable :

POST /contract/private/set-position-mode

15. D√©ploiement et CI/CD

Stack Docker Compose :

Symfony + Temporal Worker + PostgreSQL + frontend React.

Migrations Doctrine pour sch√©ma DB.

Tests int√©gration : simulateur WS (mock JSON) + API sandbox BitMart.

CI : phpunit, psalm, phpstan, eslint, jest.

16. Exploitation / Runbooks
Action	Commande / Endpoint
Purger cache	bin/console app:purge:validation-cache
Backfill donn√©es	bin/console app:backfill:klines BTCUSDT --tf=15m
Forcer revalidation	API : /api/cron/bitmart/refresh-{tf}
Monitoring	/api/debug/mtf/state/{symbol}
Audit recent	/api/debug/mtf/audit/{symbol}
17. Arborescence des fichiers
src/
‚îú Domain/
‚îÇ  ‚îú Common/Dto/[‚Ä¶]
‚îÇ  ‚îú Common/Enum/[‚Ä¶]
‚îÇ  ‚îú Common/Service/[‚Ä¶]
‚îÇ  ‚îú Kline/Service/KlineFetcher.php
‚îÇ  ‚îú Indicator/Service/IndicatorEngine.php
‚îÇ  ‚îú Mtf/Service/MtfValidator.php
‚îÇ  ‚îú Ports/In/MtfWorkflowPort.php
‚îÇ  ‚îú Ports/Out/KlineProviderPort.php
‚îÇ  ‚îî Trade/Service/OrderPlanner.php
‚îú Application/
‚îÇ  ‚îú Workflow/MtfMinuteWorkflow.php
‚îÇ  ‚îú Activities/[‚Ä¶]
‚îÇ  ‚îú Handler/[‚Ä¶]
‚îÇ  ‚îî Message/[‚Ä¶]
‚îú Infrastructure/
‚îÇ  ‚îú Http/BitmartRestClient.php
‚îÇ  ‚îú WebSocket/BitmartWsClient.php
‚îÇ  ‚îú Cache/DbValidationCache.php
‚îÇ  ‚îú Persistence/Repository/[‚Ä¶]
‚îÇ  ‚îî Config/BitmartConfig.php
‚îî Presentation/
   ‚îú Controller/[‚Ä¶]
   ‚îî Cli/[‚Ä¶]

18. Sch√©ma PostgreSQL (rappel complet)

(identique √† la version valid√©e)

CREATE TYPE timeframe AS ENUM ('4h','1h','15m','5m','1m');
CREATE TYPE signal_side AS ENUM ('LONG','SHORT','NONE');

CREATE TABLE klines (
  id BIGSERIAL PRIMARY KEY,
  symbol TEXT NOT NULL,
  timeframe timeframe NOT NULL,
  open_time TIMESTAMPTZ NOT NULL,
  open_price NUMERIC(24,12) NOT NULL,
  high_price NUMERIC(24,12) NOT NULL,
  low_price NUMERIC(24,12) NOT NULL,
  close_price NUMERIC(24,12) NOT NULL,
  volume NUMERIC(28,12),
  source TEXT NOT NULL DEFAULT 'REST',
  inserted_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
CREATE UNIQUE INDEX ux_klines_symbol_tf_open ON klines(symbol,timeframe,open_time);

CREATE TABLE indicator_snapshots (
  id BIGSERIAL PRIMARY KEY,
  symbol TEXT NOT NULL,
  timeframe timeframe NOT NULL,
  kline_time TIMESTAMPTZ NOT NULL,
  values JSONB NOT NULL,
  inserted_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
CREATE UNIQUE INDEX ux_ind_snap_symbol_tf_time ON indicator_snapshots(symbol,timeframe,kline_time);

CREATE TABLE signals (
  id BIGSERIAL PRIMARY KEY,
  symbol TEXT NOT NULL,
  timeframe timeframe NOT NULL,
  kline_time TIMESTAMPTZ NOT NULL,
  side signal_side NOT NULL,
  score DOUBLE PRECISION,
  meta JSONB DEFAULT '{}'::jsonb,
  inserted_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
CREATE UNIQUE INDEX ux_signals_symbol_tf_time ON signals(symbol,timeframe,kline_time);

CREATE TABLE validation_cache (
  cache_key TEXT PRIMARY KEY,
  payload JSONB NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE mtf_audit (
  id BIGSERIAL PRIMARY KEY,
  symbol TEXT NOT NULL,
  run_id UUID NOT NULL,
  step TEXT NOT NULL,
  timeframe timeframe,
  cause TEXT,
  details JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE order_plan (
  id BIGSERIAL PRIMARY KEY,
  symbol TEXT NOT NULL,
  plan_time TIMESTAMPTZ DEFAULT now(),
  side signal_side NOT NULL,
  risk_json JSONB NOT NULL,
  context_json JSONB NOT NULL,
  exec_json JSONB NOT NULL,
  status TEXT DEFAULT 'PLANNED'
);

19. Annexes & r√©f√©rences

üîó BitMart Futures V2 REST/WS Docs :
https://developer-pro.bitmart.com/en/futuresv2/

üîó Temporal Schedules :
https://docs.temporal.io/workflows#schedules

üîó PostgreSQL UPSERT :
https://www.postgresql.org/docs/current/sql-insert.html

üîó Symfony Hexagonal Architecture Guide :
https://symfony.com/doc/current/best_practices/hexagonal_architecture.html
