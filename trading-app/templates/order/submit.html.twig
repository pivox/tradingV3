{% extends 'base.html.twig' %}

{% block title %}Soumettre un Ordre - Trading{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-cart-plus"></i> Soumettre un Ordre
            </h1>
            <div>
                <a href="{{ path('contracts_index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Retour aux Contrats
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Message de succès avec détails complets -->
{% if order_id and order_details %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <h4 class="alert-heading">
                <i class="bi bi-check-circle"></i> Ordre soumis avec succès !
            </h4>
            <hr>
            
            <div class="row mt-3">
                <!-- Informations principales -->
                <div class="col-md-6">
                    <h6 class="text-success mb-3">
                        <i class="bi bi-info-circle"></i> Informations de l'Ordre
                    </h6>
                    <table class="table table-sm table-borderless mb-0">
                        <tbody>
                            <tr>
                                <td class="fw-bold" style="width: 40%;">Order ID:</td>
                                <td><code class="fs-5">{{ order_details.order_id }}</code></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Symbole:</td>
                                <td><strong>{{ order_details.symbol }}</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Direction:</td>
                                <td>{{ order_details.side_label }} ({{ order_details.side }})</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Type:</td>
                                <td><span class="badge bg-primary">{{ order_details.type|upper }}</span></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Taille:</td>
                                <td><strong>{{ order_details.size }} contrats</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Prix Limit:</td>
                                <td><strong>{{ order_details.limit_price|number_format(2, '.', ' ') }} USDT</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Prix TP:</td>
                                <td><strong class="text-success">{{ order_details.take_profit_price|number_format(2, '.', ' ') }} USDT</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Prix SL:</td>
                                <td><strong class="text-danger">{{ order_details.stop_loss_price|number_format(order_details.price_precision ?? 2, '.', ' ') }} USDT</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Paramètres de trading -->
                <div class="col-md-6">
                    <h6 class="text-success mb-3">
                        <i class="bi bi-calculator"></i> Paramètres de Trading
                    </h6>
                    <table class="table table-sm table-borderless mb-0">
                        <tbody>
                            <tr>
                                <td class="fw-bold" style="width: 40%;">Marge Initiale:</td>
                                <td><strong>{{ order_details.initial_margin|number_format(2, '.', ' ') }} USDT</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Levier:</td>
                                <td><strong>{{ order_details.leverage }}x</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">% Risque:</td>
                                <td><strong>{{ order_details.risk_percent|number_format(2, '.', ' ') }}%</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Montant Risqué:</td>
                                <td><strong class="text-warning">{{ order_details.risk_amount|number_format(2, '.', ' ') }} USDT</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Contract Size:</td>
                                <td>{{ order_details.contract_size|number_format(8, '.', ' ') }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Valeur Notionale:</td>
                                <td><strong>{{ order_details.notional_value|number_format(2, '.', ' ') }} USDT</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Distance TP:</td>
                                <td>
                                    {% if order_details.side == 1 %}
                                        <span class="text-success">+{{ ((order_details.take_profit_price - order_details.limit_price) / order_details.limit_price * 100)|number_format(2, '.', ' ') }}%</span>
                                    {% else %}
                                        <span class="text-success">+{{ ((order_details.limit_price - order_details.take_profit_price) / order_details.limit_price * 100)|number_format(2, '.', ' ') }}%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Distance SL:</td>
                                <td>
                                    {% if order_details.side == 1 %}
                                        <span class="text-danger">-{{ ((order_details.limit_price - order_details.stop_loss_price) / order_details.limit_price * 100)|number_format(2, '.', ' ') }}%</span>
                                    {% else %}
                                        <span class="text-danger">-{{ ((order_details.stop_loss_price - order_details.limit_price) / order_details.limit_price * 100)|number_format(2, '.', ' ') }}%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if order_details.sl_distance is defined %}
                            <tr>
                                <td class="fw-bold">Distance SL (abs):</td>
                                <td><span class="text-danger">{{ order_details.sl_distance|number_format(8, '.', ' ') }} USDT</span></td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <hr>
            
            <!-- Section Request/Response -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="accordion" id="orderDetailsAccordion">
                        <!-- Request Payload -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRequest">
                                    <i class="bi bi-arrow-up-circle me-2"></i> <strong>Données Soumises (Request)</strong>
                                </button>
                            </h2>
                            <div id="collapseRequest" class="accordion-collapse collapse" data-bs-parent="#orderDetailsAccordion">
                                <div class="accordion-body">
                                    <p class="mb-2"><strong>Endpoint:</strong> <code>POST /contract/private/submit-order</code></p>
                                    <pre class="bg-light p-3 rounded"><code>{
  "symbol": "{{ order_details.request_payload.symbol }}",
  "side": {{ order_details.request_payload.side }},
  "type": "{{ order_details.request_payload.type }}",
  "price": "{{ order_details.request_payload.price }}",
  "size": {{ order_details.request_payload.size }},
  "open_type": "{{ order_details.request_payload.open_type }}",
  "preset_take_profit_price": "{{ order_details.request_payload.preset_take_profit_price }}",
  "preset_take_profit_price_type": {{ order_details.request_payload.preset_take_profit_price_type }},
  "preset_stop_loss_price": "{{ order_details.request_payload.preset_stop_loss_price }}",
  "preset_stop_loss_price_type": {{ order_details.request_payload.preset_stop_loss_price_type }}
}</code></pre>
                                    <table class="table table-sm table-bordered mt-3">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Champ</th>
                                                <th>Type</th>
                                                <th>Valeur</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>symbol</code></td>
                                                <td>string</td>
                                                <td>{{ order_details.request_payload.symbol }}</td>
                                                <td>Symbole du contrat (ex: BTCUSDT)</td>
                                            </tr>
                                            <tr>
                                                <td><code>side</code></td>
                                                <td>integer</td>
                                                <td>{{ order_details.request_payload.side }}</td>
                                                <td>1 = Open Long, 4 = Open Short</td>
                                            </tr>
                                            <tr>
                                                <td><code>type</code></td>
                                                <td>string</td>
                                                <td>{{ order_details.request_payload.type }}</td>
                                                <td>Type d'ordre: "limit" ou "market"</td>
                                            </tr>
                                            <tr>
                                                <td><code>price</code></td>
                                                <td>string</td>
                                                <td>{{ order_details.request_payload.price }}</td>
                                                <td>Prix limite (requis pour type "limit")</td>
                                            </tr>
                                            <tr>
                                                <td><code>size</code></td>
                                                <td>integer</td>
                                                <td>{{ order_details.request_payload.size }}</td>
                                                <td>Nombre de contrats</td>
                                            </tr>
                                            <tr>
                                                <td><code>open_type</code></td>
                                                <td>string</td>
                                                <td>{{ order_details.request_payload.open_type }}</td>
                                                <td>"isolated" = Marge isolée, "cross" = Marge croisée</td>
                                            </tr>
                                            <tr>
                                                <td><code>preset_take_profit_price</code></td>
                                                <td>string</td>
                                                <td>{{ order_details.request_payload.preset_take_profit_price }}</td>
                                                <td>Prix de Take Profit pré-configuré</td>
                                            </tr>
                                            <tr>
                                                <td><code>preset_take_profit_price_type</code></td>
                                                <td>integer</td>
                                                <td>{{ order_details.request_payload.preset_take_profit_price_type }}</td>
                                                <td>1 = Prix fixe</td>
                                            </tr>
                                            <tr>
                                                <td><code>preset_stop_loss_price</code></td>
                                                <td>string</td>
                                                <td>{{ order_details.request_payload.preset_stop_loss_price }}</td>
                                                <td>Prix de Stop Loss pré-configuré (calculé à partir du risque)</td>
                                            </tr>
                                            <tr>
                                                <td><code>preset_stop_loss_price_type</code></td>
                                                <td>integer</td>
                                                <td>{{ order_details.request_payload.preset_stop_loss_price_type }}</td>
                                                <td>1 = Prix fixe</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Leverage Request/Response -->
                        {% if order_details.leverage_request %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLeverage">
                                    <i class="bi bi-arrows-angle-contract me-2"></i> <strong>Configuration du Levier</strong>
                                </button>
                            </h2>
                            <div id="collapseLeverage" class="accordion-collapse collapse" data-bs-parent="#orderDetailsAccordion">
                                <div class="accordion-body">
                                    <p class="mb-2"><strong>Endpoint:</strong> <code>POST /contract/private/submit-leverage</code></p>
                                    <p class="text-info mb-3">
                                        <i class="bi bi-info-circle"></i> 
                                        <strong>Important:</strong> Le levier doit être défini AVANT de soumettre l'ordre via un endpoint séparé.
                                    </p>
                                    
                                    <h6 class="mt-3">Request (Levier)</h6>
                                    <pre class="bg-light p-3 rounded"><code>{
  "symbol": "{{ order_details.leverage_request.symbol }}",
  "leverage": {{ order_details.leverage_request.leverage }},
  "open_type": "{{ order_details.leverage_request.open_type }}"
}</code></pre>
                                    
                                    <h6 class="mt-3">Response (Levier)</h6>
                                    <pre class="bg-light p-3 rounded"><code>{{ order_details.leverage_response|json_encode(448) }}</code></pre>
                                    
                                    <table class="table table-sm table-bordered mt-3">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Champ</th>
                                                <th>Valeur Demandée</th>
                                                <th>Valeur Confirmée</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>symbol</code></td>
                                                <td>{{ order_details.leverage_request.symbol }}</td>
                                                <td>-</td>
                                                <td>Symbole du contrat</td>
                                            </tr>
                                            <tr>
                                                <td><code>leverage</code></td>
                                                <td><strong>{{ order_details.leverage_request.leverage }}x</strong></td>
                                                <td>
                                                    {% if order_details.leverage_response.data.leverage is defined %}
                                                        <strong class="{% if order_details.leverage_response.data.leverage != order_details.leverage_request.leverage %}text-warning{% else %}text-success{% endif %}">
                                                            {{ order_details.leverage_response.data.leverage }}x
                                                        </strong>
                                                        {% if order_details.leverage_response.data.leverage != order_details.leverage_request.leverage %}
                                                            <br><small class="text-warning">⚠️ Différent de la demande!</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </td>
                                                <td>Niveau de levier configuré</td>
                                            </tr>
                                            <tr>
                                                <td><code>open_type</code></td>
                                                <td>{{ order_details.leverage_request.open_type }}</td>
                                                <td>-</td>
                                                <td>Type d'ouverture (isolated/cross)</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Response -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResponse">
                                    <i class="bi bi-arrow-down-circle me-2"></i> <strong>Réponse BitMart (Response)</strong>
                                </button>
                            </h2>
                            <div id="collapseResponse" class="accordion-collapse collapse" data-bs-parent="#orderDetailsAccordion">
                                <div class="accordion-body">
                                    <p class="mb-2"><strong>Status Code:</strong> <span class="badge bg-success">200 OK</span></p>
                                    <pre class="bg-light p-3 rounded"><code>{{ order_details.response_full|json_encode(448) }}</code></pre>
                                    <table class="table table-sm table-bordered mt-3">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Champ</th>
                                                <th>Type</th>
                                                <th>Valeur</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>code</code></td>
                                                <td>integer</td>
                                                <td><span class="badge bg-success">{{ order_details.response_full.code }}</span></td>
                                                <td>Code de statut (1000 = succès)</td>
                                            </tr>
                                            <tr>
                                                <td><code>message</code></td>
                                                <td>string</td>
                                                <td>{{ order_details.response_full.message ?? 'N/A' }}</td>
                                                <td>Message de statut</td>
                                            </tr>
                                            <tr class="table-info">
                                                <td><code>data.order_id</code></td>
                                                <td>string/integer</td>
                                                <td><strong class="fs-5">{{ order_details.order_id }}</strong></td>
                                                <td><strong>ID unique de l'ordre BitMart</strong></td>
                                            </tr>
                                            {% if order_details.response_full.data.client_order_id is defined %}
                                            <tr>
                                                <td><code>data.client_order_id</code></td>
                                                <td>string</td>
                                                <td>{{ order_details.response_full.data.client_order_id }}</td>
                                                <td>ID client de l'ordre (si fourni)</td>
                                            </tr>
                                            {% endif %}
                                            {% if order_details.response_full.data is iterable %}
                                                {% for key, value in order_details.response_full.data %}
                                                    {% if key != 'order_id' and key != 'client_order_id' %}
                                                    <tr>
                                                        <td><code>data.{{ key }}</code></td>
                                                        <td>{{ value is same as(true) or value is same as(false) ? 'boolean' : (value is iterable ? 'array' : (value matches '/^[0-9]+$/' ? 'integer' : 'string')) }}</td>
                                                        <td>
                                                            {% if value is iterable %}
                                                                <pre class="mb-0 small">{{ value|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
                                                            {% else %}
                                                                {{ value }}
                                                            {% endif %}
                                                        </td>
                                                        <td>Donnée supplémentaire de la réponse</td>
                                                    </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr>
            <p class="mb-0">
                <small>
                    <i class="bi bi-clock"></i> Soumis le {{ 'now'|date('d/m/Y à H:i:s') }} 
                    | Votre ordre a été soumis à BitMart avec le Take Profit configuré.
                </small>
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% elseif order_id %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <h4 class="alert-heading">
                <i class="bi bi-check-circle"></i> Ordre soumis avec succès !
            </h4>
            <p class="mb-0">
                <strong>Order ID:</strong> <code class="fs-5">{{ order_id }}</code>
            </p>
            {% if calculated_size %}
            <p class="mb-0 mt-2">
                <strong>Taille calculée:</strong> {{ calculated_size }} contrats
            </p>
            {% endif %}
            <hr>
            <p class="mb-0">Votre ordre a été soumis à BitMart avec le Take Profit configuré.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endif %}

<!-- Message d'erreur -->
{% if error %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h4 class="alert-heading">
                <i class="bi bi-exclamation-triangle"></i> Erreur
            </h4>
            <p class="mb-0">{{ error }}</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endif %}

<!-- Formulaire -->
<div class="row">
    <div class="col-lg-8 offset-lg-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-file-earmark-text"></i> Informations de l'Ordre
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ path('order_submit') }}" id="orderForm">
                    <div class="row">
                        <!-- Symbole -->
                        <div class="col-md-6 mb-3">
                            <label for="symbol" class="form-label">
                                Symbole <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="symbol" name="symbol" required onchange="updatePriceInfo()">
                                <option value="">-- Sélectionner un symbole --</option>
                                {% for contract in contracts %}
                                <option value="{{ contract }}">{{ contract }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Choisissez le contrat à trader</div>
                        </div>

                        <!-- Direction -->
                        <div class="col-md-6 mb-3">
                            <label for="side" class="form-label">
                                Direction <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="side" name="side" required>
                                <option value="">-- Sélectionner --</option>
                                <option value="1">Achat (Open Long)</option>
                                <option value="4">Vente (Open Short)</option>
                            </select>
                            <div class="form-text">1 = Achat, 4 = Vente</div>
                        </div>

                        <!-- Marge Initiale -->
                        <div class="col-md-6 mb-3">
                            <label for="initial_margin" class="form-label">
                                Marge Initiale (USDT) <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-control" 
                                       id="initial_margin" 
                                       name="initial_margin" 
                                       required 
                                       step="0.01"
                                       min="0"
                                       placeholder="100.00"
                                       oninput="calculateSize()">
                                <span class="input-group-text">USDT</span>
                            </div>
                            <div class="form-text">Montant de la marge à utiliser</div>
                        </div>

                        <!-- Pourcentage de Risque -->
                        <div class="col-md-6 mb-3">
                            <label for="risk_percent" class="form-label">
                                % Risque <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-control" 
                                       id="risk_percent" 
                                       name="risk_percent" 
                                       required 
                                       step="0.1"
                                       min="0"
                                       max="100"
                                       placeholder="2.0"
                                       oninput="calculateSize()">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">Pourcentage de risque de la marge</div>
                        </div>

                        <!-- Prix TP (Take Profit) -->
                        <div class="col-md-6 mb-3">
                            <label for="take_profit_price" class="form-label">
                                Prix TP <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-control" 
                                       id="take_profit_price" 
                                       name="take_profit_price" 
                                       required 
                                       step="0.01"
                                       min="0"
                                       placeholder="0.00"
                                       oninput="calculateSize()">
                                <span class="input-group-text">USDT</span>
                            </div>
                            <div class="form-text">Prix de Take Profit (profit cible)</div>
                        </div>

                        <!-- Levier -->
                        <div class="col-md-6 mb-3">
                            <label for="leverage" class="form-label">
                                Levier <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="leverage" 
                                   name="leverage" 
                                   required 
                                   step="1"
                                   min="1"
                                   max="125"
                                   placeholder="10"
                                   oninput="calculateSize()">
                            <div class="form-text">Niveau de levier (1-125)</div>
                        </div>

                        <!-- Prix Limit -->
                        <div class="col-md-6 mb-3">
                            <label for="limit_price" class="form-label">
                                Prix Limit <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-control" 
                                       id="limit_price" 
                                       name="limit_price" 
                                       required 
                                       step="0.01"
                                       min="0"
                                       placeholder="0.00"
                                       oninput="calculateSize()">
                                <span class="input-group-text">USDT</span>
                            </div>
                            <div class="form-text">Prix d'entrée limite</div>
                        </div>

                        <!-- Taille Calculée (Read-only) -->
                        <div class="col-md-6 mb-3">
                            <label for="calculated_size_display" class="form-label">
                                Taille Calculée
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="calculated_size_display" 
                                   readonly
                                   placeholder="Calcul automatique...">
                            <div class="form-text">Nombre de contrats (calculé automatiquement)</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="reset" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="bi bi-arrow-counterclockwise"></i> Réinitialiser
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> Soumettre l'Ordre
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Informations de Calcul -->
<div class="row mt-4">
    <div class="col-lg-8 offset-lg-2">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-calculator"></i> Calcul de la Taille
                </h6>
            </div>
            <div class="card-body">
                <p><strong>Formule:</strong></p>
                <ul class="mb-0">
                    <li><strong>Valeur Notionale</strong> = Marge Initiale × Levier</li>
                    <li><strong>Taille (contrats)</strong> = Valeur Notionale ÷ (Prix Limit × Contract Size)</li>
                    <li><strong>Contract Size</strong> = Taille d'un contrat en USDT (généralement 1 pour les contrats USDT)</li>
                    <li>Le Take Profit sera configuré automatiquement au prix TP spécifié</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Informations -->
<div class="row mt-4">
    <div class="col-lg-8 offset-lg-2">
        <div class="card border-secondary">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Informations
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>Direction:</strong> 1 = Achat (Open Long), 4 = Vente (Open Short)</li>
                    <li><strong>Marge Initiale:</strong> Montant en USDT que vous souhaitez utiliser comme marge</li>
                    <li><strong>% Risque:</strong> Pourcentage de la marge que vous êtes prêt à risquer</li>
                    <li><strong>Prix TP:</strong> Prix de Take Profit où l'ordre sera automatiquement clôturé en profit</li>
                    <li><strong>Levier:</strong> Multiplicateur de la marge (ex: 10x = 1000 USDT avec 100 USDT de marge)</li>
                    <li><strong>Prix Limit:</strong> Prix d'entrée pour l'ordre limit</li>
                    <li><strong>Type:</strong> L'ordre sera toujours de type <code>limit</code> avec le prix spécifié</li>
                    <li class="text-warning"><strong>Attention:</strong> Les ordres non exécutés seront automatiquement annulés après 2 minutes</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
// Stocker les contract sizes (sera rempli dynamiquement ou avec une valeur par défaut)
const contractSizes = {
    // Valeurs par défaut courantes pour BitMart Futures (1 USDT par contrat généralement)
    // Ces valeurs seront mises à jour si on récupère les données depuis l'API
};

// Valeur par défaut du contract_size (généralement 1 pour la plupart des contrats USDT)
const DEFAULT_CONTRACT_SIZE = 1;

function calculateSize() {
    const initialMargin = parseFloat(document.getElementById('initial_margin').value) || 0;
    const leverage = parseFloat(document.getElementById('leverage').value) || 0;
    const limitPrice = parseFloat(document.getElementById('limit_price').value) || 0;
    const symbol = document.getElementById('symbol').value;
    const sizeDisplay = document.getElementById('calculated_size_display');
    
    // Utiliser le contract_size du symbole ou la valeur par défaut
    const contractSize = contractSizes[symbol] || DEFAULT_CONTRACT_SIZE;
    
    if (initialMargin > 0 && leverage > 0 && limitPrice > 0 && contractSize > 0) {
        // Formule correcte: Notional = Prix × Contract Size × Nombre de contrats
        // Donc: Nombre de contrats = Notional / (Prix × Contract Size)
        const notionalValue = initialMargin * leverage;
        const calculatedSize = Math.floor(notionalValue / (limitPrice * contractSize));
        
        sizeDisplay.value = calculatedSize + ' contrats';
        
        if (calculatedSize <= 0) {
            sizeDisplay.value = 'Erreur: Vérifiez les valeurs (contract_size=' + contractSize + ')';
            sizeDisplay.classList.add('is-invalid');
        } else {
            sizeDisplay.classList.remove('is-invalid');
            // Afficher aussi la valeur notionale pour info
            const infoText = ` (Notional: ${notionalValue.toFixed(2)} USDT)`;
            if (!sizeDisplay.value.includes('Notional')) {
                sizeDisplay.value += infoText;
            }
        }
    } else {
        sizeDisplay.value = '';
        sizeDisplay.classList.remove('is-invalid');
    }
}

function resetForm() {
    document.getElementById('orderForm').reset();
    document.getElementById('calculated_size_display').value = '';
    document.getElementById('calculated_size_display').classList.remove('is-invalid');
}

function updatePriceInfo() {
    // Placeholder pour récupérer le prix actuel du marché (futur)
    const symbol = document.getElementById('symbol').value;
    if (symbol) {
        // TODO: Récupérer le prix actuel via API
    }
}

// Validation du formulaire avant soumission
document.getElementById('orderForm').addEventListener('submit', function(e) {
    const initialMargin = parseFloat(document.getElementById('initial_margin').value);
    const riskPercent = parseFloat(document.getElementById('risk_percent').value);
    const takeProfitPrice = parseFloat(document.getElementById('take_profit_price').value);
    const leverage = parseFloat(document.getElementById('leverage').value);
    const limitPrice = parseFloat(document.getElementById('limit_price').value);
    
    // Validation des valeurs
    if (!initialMargin || initialMargin <= 0) {
        e.preventDefault();
        alert('La marge initiale doit être un nombre positif.');
        return false;
    }
    
    if (!riskPercent || riskPercent <= 0 || riskPercent > 100) {
        e.preventDefault();
        alert('Le pourcentage de risque doit être entre 0 et 100.');
        return false;
    }
    
    if (!takeProfitPrice || takeProfitPrice <= 0) {
        e.preventDefault();
        alert('Le prix TP doit être un nombre positif.');
        return false;
    }
    
    if (!leverage || leverage <= 0) {
        e.preventDefault();
        alert('Le levier doit être un nombre positif.');
        return false;
    }
    
    if (!limitPrice || limitPrice <= 0) {
        e.preventDefault();
        alert('Le prix limit doit être un nombre positif.');
        return false;
    }
    
    // Vérifier la logique du TP par rapport au prix limit et à la direction
    const side = parseInt(document.getElementById('side').value);
    if (side === 1 && takeProfitPrice <= limitPrice) {
        // Long: TP doit être > prix d'entrée
        if (!confirm('Pour un ordre Long, le prix TP devrait être supérieur au prix limit. Continuer ?')) {
            e.preventDefault();
            return false;
        }
    } else if (side === 4 && takeProfitPrice >= limitPrice) {
        // Short: TP doit être < prix d'entrée
        if (!confirm('Pour un ordre Short, le prix TP devrait être inférieur au prix limit. Continuer ?')) {
            e.preventDefault();
            return false;
        }
    }
    
    // Confirmation avant soumission
    if (!confirm('Êtes-vous sûr de vouloir soumettre cet ordre ?')) {
        e.preventDefault();
        return false;
    }
});

// Initialiser le calcul au chargement
document.addEventListener('DOMContentLoaded', function() {
    calculateSize();
});
</script>
{% endblock %}
