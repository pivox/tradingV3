{% extends 'base.html.twig' %}

{% block title %}États MTF - Trading{% endblock %}

{% block body %}
    <style>
        .mtf-summary-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: flex-end;
        }
        .mtf-summary-meta {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: #475569;
        }
        td.table-success-subtle {
            background-color: #d1fae5 !important;
            color: #065f46 !important;
        }
        td.table-warning-subtle {
            background-color: #fef3c7 !important;
            color: #92400e !important;
        }
        td.table-info-subtle {
            background-color: #dbeafe !important;
            color: #1e40af !important;
        }
        .timeframe-recent {
            position: relative;
            background-color: #dcfce7 !important;
        }
        .timeframe-recent::after {
            content: '●';
            color: #16a34a;
            font-size: 0.65rem;
            position: absolute;
            top: 4px;
            right: 6px;
        }

        .timeframe-cell {
            min-width: 120px;
        }
        .side-item {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .sides-container {
            max-width: 150px;
        }
    </style>

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="bi bi-layers"></i> États MTF (Multi-Timeframe)
                </h1>
                <div>
                    <div class="form-check form-switch d-inline-block me-3">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">
                            Actualisation auto (30s)
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="refreshTable()">
                        <i class="bi bi-arrow-clockwise"></i> Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglets -->
    <ul class="nav nav-tabs mb-4" id="mtfStatesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-list" data-bs-toggle="tab" data-bs-target="#panel-list" type="button" role="tab" aria-controls="panel-list" aria-selected="true">
                Liste
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-audit-summary" data-bs-toggle="tab" data-bs-target="#panel-audit-summary" type="button" role="tab" aria-controls="panel-audit-summary" aria-selected="false">
                Synthèse audit
            </button>
        </li>
    </ul>

    <div class="tab-content" id="mtfStatesTabsContent">
        <!-- Onglet Liste -->
        <div class="tab-pane fade show active" id="panel-list" role="tabpanel" aria-labelledby="tab-list">
            <!-- Filtres -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-funnel"></i> Filtres
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="filterSymbol" class="form-label">Symbole</label>
                                    <input type="text" class="form-control" id="filterSymbol" placeholder="Ex: BTCUSDT">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                        <i class="bi bi-x-circle"></i> Effacer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 id="totalStates">0</h5>
                            <small>États MTF</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 id="k4hCount">0</h5>
                            <small>Avec K4h</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 id="k1hCount">0</h5>
                            <small>Avec K1h</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 id="k15mCount">0</h5>
                            <small>Avec K15m</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-secondary text-white">
                        <div class="card-body text-center">
                            <h5 id="k5mCount">0</h5>
                            <small>Avec K5m</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-dark text-white">
                        <div class="card-body text-center">
                            <h5 id="k1mCount">0</h5>
                            <small>Avec K1m</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table des états MTF -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-table"></i> Liste des États MTF ({{ mtfStates|length }})
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="mtfStatesTable" class="table table-striped table-hover">
                                    <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Symbole</th>
                                        <th>K4h</th>
                                        <th>K1h</th>
                                        <th>K15m</th>
                                        <th>K5m</th>
                                        <th>K1m</th>
                                        <th>Sides</th>
                                        <th>Mis à jour</th>
                                    </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Synthèse audit -->
        <div class="tab-pane fade" id="panel-audit-summary" role="tabpanel" aria-labelledby="tab-audit-summary">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-layers"></i> Synthèse audit MTF
                            </h6>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshAuditSummary(true)">
                                <i class="bi bi-arrow-clockwise"></i> Rafraîchir
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mtf-summary-toolbar mb-3">
                                <div class="flex-grow-1">
                                    <label for="auditSummarySearch" class="form-label">Filtrer par symbole</label>
                                    <input type="text" class="form-control" id="auditSummarySearch" placeholder="Ex: BTCUSDT">
                                </div>
                                <div>
                                    <label for="auditSummaryMode" class="form-label">Mode</label>
                                    <select id="auditSummaryMode" class="form-select form-select-sm">
                                        <!-- Rempli dynamiquement -->
                                    </select>
                                </div>
                                <div class="mtf-summary-meta" id="auditSummaryMeta">
                                    <span>Total symboles: <strong id="auditSummaryCount">0</strong></span>
                                    <span>Dernière génération: <strong id="auditSummaryUpdated">-</strong></span>
                                    <span>TF de départ: <strong id="auditSummaryStartFrom">-</strong></span>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover" id="auditSummaryTable">
                                    <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Symbole</th>
                                        <th scope="col">Règle</th>
                                        <th scope="col" data-tf="4h"  class="tf-header tf-4h">4H</th>
                                        <th scope="col" data-tf="1h"  class="tf-header tf-1h">1H</th>
                                        <th scope="col" data-tf="15m" class="tf-header tf-15m">15M</th>
                                        <th scope="col" data-tf="5m"  class="tf-header tf-5m">5M</th>
                                        <th scope="col" data-tf="1m"  class="tf-header tf-1m">1M</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="bi bi-hourglass-split me-2"></i>Chargement des données...
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div id="auditSummaryEmpty" class="alert alert-info d-none">
                                Aucun symbole ne correspond aux critères.
                            </div>

                            <div class="mt-3 small text-muted">
                                <strong>Légende règles :</strong><br>
                                <span class="badge bg-success me-1">Règle 1</span> cascade complète jusqu'à 1m<br>
                                <span class="badge bg-info me-1">Règle 2</span> cascade complète jusqu'à 5m (sans 1m)<br>
                                <span class="badge bg-warning me-1">Règle 3</span> cascade complète jusqu'à 15m (sans 5m/1m)<br>
                                <span class="badge bg-secondary me-1">Règle 4+</span> partiel (4h/1h, etc.)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        let autoRefreshInterval;
        const TF_DURATION_MINUTES = {
            '4h': 240,
            '1h': 60,
            '15m': 15,
            '5m': 5,
            '1m': 1,
        };

        // Synthèse audit
        let auditSummaryData = [];
        let auditSummaryLoaded = false;
        let auditSummaryLoading = false;
        let auditSummaryCurrentMode = null;
        let auditSummaryStartFrom = '4H';

        $(document).ready(function() {
            // Charger stats
            loadStats();

            // Initialisation DataTables
            $('#mtfStatesTable').DataTable({
                processing: true,
                serverSide: true,
                pageLength: 25,
                order: [[8, 'desc']],
                ajax: {
                    url: '{{ path('mtf_states_data') }}',
                    data: function(d){ d.symbol = $('#filterSymbol').val(); }
                },
                columns: [
                    { data: 'id', render: d => `<code>${d}</code>` },
                    { data: 'symbol', render: d => `<strong>${d}</strong>` },
                    { data: 'k4h_time', render: renderTf('4h', 'danger') },
                    { data: 'k1h_time', render: renderTf('1h', 'success') },
                    { data: 'k15m_time', render: renderTf('15m', 'warning') },
                    { data: 'k5m_time', render: renderTf('5m', 'secondary') },
                    { data: 'k1m_time', render: renderTf('1m', 'primary') },
                    { data: 'sides', orderable: false, render: renderSides },
                    { data: 'updated_at' },
                ],
                columnDefs: [ { orderable: false, targets: [7] } ]
            });

            // Filtres
            $('#filterSymbol').on('change keyup', function() {
                applyFilters();
            });

            // Auto-refresh
            $('#autoRefresh').on('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });

            // Auto-refresh par défaut
            startAutoRefresh();

            // Onglet synthèse audit : lazy load
            const auditSummaryTabEl = document.getElementById('tab-audit-summary');
            auditSummaryTabEl.addEventListener('shown.bs.tab', function () {
                if (!auditSummaryLoaded) {
                    refreshAuditSummary(false);
                }
            });

            $('#auditSummarySearch').on('input', function() {
                renderAuditSummaryTable();
            });

            $('#auditSummaryMode').on('change', function() {
                auditSummaryLoaded = false;
                refreshAuditSummary(true);
            });
        });

        // Stats globales
        async function loadStats(){
            try {
                const resp = await fetch('{{ path('mtf_states_stats') }}');
                const s = await resp.json();
                document.getElementById('totalStates').textContent = s.total ?? 0;
                document.getElementById('k4hCount').textContent = s.k4h ?? 0;
                document.getElementById('k1hCount').textContent = s.k1h ?? 0;
                document.getElementById('k15mCount').textContent = s.k15m ?? 0;
                document.getElementById('k5mCount').textContent = s.k5m ?? 0;
                document.getElementById('k1mCount').textContent = s.k1m ?? 0;
            } catch(e) {
                console.error('Erreur stats MTF:', e);
            }
        }

        function applyFilters() {
            const table = $('#mtfStatesTable').DataTable();
            const symbol = $('#filterSymbol').val();

            table.search('').columns().search('').draw();

            if (symbol) {
                table.column(1).search(symbol, false, false);
            }

            table.draw();
        }

        function clearFilters() {
            $('#filterSymbol').val('');
            $('#mtfStatesTable').DataTable().search('').columns().search('').draw();
        }

        function refreshTable() {
            location.reload();
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(function() {
                $('#mtfStatesTable').DataTable().ajax.reload(null, false);
                loadStats();
            }, 30000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Rendu des timeframes (onglet liste)
        function renderTf(label, color){
            return function(val){
                const badge = `<span class="badge bg-${color}">${label}</span>`;
                if (!val) {
                    return badge + ' <span class="badge bg-secondary">Manquant</span>';
                }
                const dt = new Date(val + 'Z');
                const ageMin = Math.floor((Date.now() - dt.getTime()) / 60000);
                let st = 'danger', txt = 'Ancien';
                if (ageMin < 5) {
                    st = 'success'; txt = 'À jour';
                } else if (ageMin < 15) {
                    st = 'warning'; txt = 'Récent';
                }
                return `${badge} <span class="badge bg-${st}">${txt}</span><div class="small text-muted">${dt.toLocaleString()}</div>`;
            }
        }

        function renderSides(sides){
            if (!sides || Object.keys(sides).length === 0) {
                return '<span class="text-muted">-</span>';
            }
            const parts = [];
            for (const [tf, side] of Object.entries(sides)){
                const normalized = (side || '').toString().toUpperCase();
                let cls = 'secondary';
                let label = normalized || '-';
                if (normalized === 'LONG') {
                    cls = 'success';
                    label = 'long';
                } else if (normalized === 'SHORT') {
                    cls = 'danger';
                    label = 'short';
                }
                const sideBadge = `<span class="badge bg-${cls}">${label}</span>`;
                parts.push(`<div class="side-item mb-1"><span class="badge bg-info">${tf}</span> ${sideBadge}</div>`);
            }
            return `<div class="sides-container">${parts.join('')}</div>`;
        }

        // Masquer/afficher les colonnes TF en fonction du start_from_timeframe
        function updateVisibleTimeframeColumns(startFrom) {
            // startFrom arrive en majuscules (ex: '4H', '1H')
            const start = (startFrom || '').toUpperCase();
            const tfToHide = [];

            // Si on commence en 1H, on masque 4H
            if (start === '1H') {
                tfToHide.push('4h');
            }

            const allTf = ['4h','1h','15m','5m','1m'];

            allTf.forEach(tf => {
                const hide = tfToHide.includes(tf);
                const selector = `#auditSummaryTable [data-tf="${tf}"]`;
                document.querySelectorAll(selector).forEach(el => {
                    if (hide) {
                        el.classList.add('d-none');
                    } else {
                        el.classList.remove('d-none');
                    }
                });
            });
        }

        // Synthèse audit : chargement
        function refreshAuditSummary(forceReload) {
            if (auditSummaryLoading) {
                return;
            }
            if (auditSummaryLoaded && !forceReload) {
                return;
            }

            auditSummaryLoading = true;
            const tbody = document.querySelector('#auditSummaryTable tbody');
            tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center text-muted py-4">
                <i class="bi bi-arrow-repeat me-2"></i>Actualisation de la synthèse...
            </td>
        </tr>
    `;
            document.getElementById('auditSummaryEmpty').classList.add('d-none');

            const symbol = ($('#auditSummarySearch').val() || '').toString();
            const modeSelect = document.getElementById('auditSummaryMode');
            const selectedMode = modeSelect && modeSelect.value ? modeSelect.value : '';

            const params = [];
            if (symbol) params.push('symbol=' + encodeURIComponent(symbol));
            if (selectedMode) params.push('mode=' + encodeURIComponent(selectedMode));

            const url = '{{ path('mtf_states_audit_summary') }}' + (params.length ? '?' + params.join('&') : '');

            fetch(url)
                .then((resp) => {
                    if (!resp.ok) {
                        throw new Error('Réponse invalide');
                    }
                    return resp.json();
                })
                .then((payload) => {
                    auditSummaryLoaded = true;
                    auditSummaryData = Array.isArray(payload.data) ? payload.data : [];

                    const count = typeof payload.count === 'number' ? payload.count : auditSummaryData.length;
                    document.getElementById('auditSummaryCount').textContent = count.toString();
                    document.getElementById('auditSummaryUpdated').textContent = formatDateUtc(payload.generated_at || payload.generatedAt || null);

                    const mode = (payload.mode || '').toString();
                    const startFrom = (payload.start_from_timeframe || '4h').toString().toUpperCase();
                    auditSummaryCurrentMode = mode;
                    auditSummaryStartFrom = startFrom;

                    const startFromEl = document.getElementById('auditSummaryStartFrom');
                    if (startFromEl) {
                        startFromEl.textContent = startFrom;
                    }

                    const availableModes = Array.isArray(payload.available_modes) ? payload.available_modes : [];
                    if (modeSelect) {
                        const existingOptions = Array.from(modeSelect.options).map(o => o.value);
                        const same = availableModes.length === existingOptions.length
                            && availableModes.every((m, i) => m === existingOptions[i]);
                        if (!same) {
                            modeSelect.innerHTML = availableModes.map((m) =>
                                `<option value="${m}"${m === mode ? ' selected' : ''}>${m}</option>`
                            ).join('');
                        } else if (mode && modeSelect.value !== mode) {
                            modeSelect.value = mode;
                        }
                    }

                    // Met à jour la visibilité des colonnes TF selon start_from_timeframe
                    updateVisibleTimeframeColumns(startFrom);

                    renderAuditSummaryTable();
                })
                .catch((err) => {
                    console.error('Erreur synthèse audit MTF:', err);
                    tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>Impossible de charger la synthèse.
                    </td>
                </tr>
            `;
                })
                .finally(() => {
                    auditSummaryLoading = false;
                });
        }

        function renderAuditSummaryTable() {
            const tbody = document.querySelector('#auditSummaryTable tbody');
            const emptyAlert = document.getElementById('auditSummaryEmpty');
            const filterValue = ($('#auditSummarySearch').val() || '').toString().trim().toUpperCase();

            if (!Array.isArray(auditSummaryData) || auditSummaryData.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-database-exclamation me-2"></i>Aucune donnée disponible.
                </td>
            </tr>
        `;
                emptyAlert.classList.remove('d-none');
                return;
            }

            const prepared = auditSummaryData.filter((row) => {
                if (!filterValue) {
                    return true;
                }
                return (row.symbol || '').toUpperCase().includes(filterValue);
            });

            if (prepared.length === 0) {
                tbody.innerHTML = '';
                emptyAlert.classList.remove('d-none');
                return;
            }

            emptyAlert.classList.add('d-none');

            prepared.sort((a, b) => {
                const filledA = countFilledTimeframes(a);
                const filledB = countFilledTimeframes(b);
                if (filledA !== filledB) {
                    return filledB - filledA;
                }
                const rankA = a.rule_rank ?? 999;
                const rankB = b.rule_rank ?? 999;
                if (rankA !== rankB) {
                    return rankA - rankB;
                }
                return (a.symbol || '').localeCompare(b.symbol || '');
            });

            const rowsHtml = prepared.map((row) => {
                const symbolLabel = escapeHtml(row.symbol || '');
                const ruleRank = row.rule_rank ?? null;
                const ruleBadge = ruleRank !== null
                    ? `<span class="badge bg-${ruleRank === 1 ? 'success' : ruleRank === 2 ? 'info' : ruleRank === 3 ? 'warning' : 'secondary'}">Règle ${ruleRank}</span>`
                    : '<span class="text-muted">-</span>';

                const timeframes = [
                    { tf: '4h', key: 'k4h_time' },
                    { tf: '1h', key: 'k1h_time' },
                    { tf: '15m', key: 'k15m_time' },
                    { tf: '5m', key: 'k5m_time' },
                    { tf: '1m', key: 'k1m_time' }
                ];

                const cells = timeframes.map(({ tf, key }) => {
                    const timeValue = row[key] || null;
                    if (!timeValue) {
                        return `<td class="text-muted" data-tf="${tf}">-</td>`;
                    }

                    const classes = [];
                    if (ruleRank === 1) {
                        classes.push('table-success-subtle');
                    } else if (ruleRank === 2) {
                        classes.push('table-info-subtle');
                    } else if (ruleRank === 3) {
                        classes.push('table-warning-subtle');
                    }
                    if (isRecentTimeframe(tf, timeValue)) {
                        classes.push('timeframe-recent');
                    }

                    const formattedDate = formatDateUtc(timeValue);
                    const cls = classes.join(' ');
                    return `<td data-tf="${tf}" class="${cls}">
                <div class="small">${formattedDate}</div>
            </td>`;
                }).join('');

                return `
            <tr>
                <td><strong>${symbolLabel}</strong></td>
                <td>${ruleBadge}</td>
                ${cells}
            </tr>
        `;
            }).join('');

            tbody.innerHTML = rowsHtml;

            // Réapplique la visibilité des colonnes (utile après rerender)
            updateVisibleTimeframeColumns(auditSummaryStartFrom);
        }

        function formatDateUtc(value) {
            if (!value) {
                return '-';
            }
            const parsed = Date.parse(value);
            if (Number.isNaN(parsed)) {
                return '-';
            }
            return new Date(parsed).toLocaleString('fr-FR', {
                timeZone: 'UTC',
                hour12: false,
            });
        }

        function escapeHtml(value) {
            if (typeof value !== 'string') {
                return '';
            }
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt/')
                .replace(/>/g, '&gt/')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function countFilledTimeframes(row) {
            const keys = ['k4h_time', 'k1h_time', 'k15m_time', 'k5m_time', 'k1m_time'];
            return keys.reduce((acc, key) => acc + (row[key] ? 1 : 0), 0);
        }

        function isRecentTimeframe(tf, isoString) {
            const durationMin = TF_DURATION_MINUTES[tf];
            if (!durationMin) {
                return false;
            }
            const valueMs = Date.parse(isoString);
            if (Number.isNaN(valueMs)) {
                return false;
            }
            const durationMs = durationMin * 60000;
            const adjustedNow = Date.now() - durationMs;
            const lastClosedStart = Math.floor(adjustedNow / durationMs) * durationMs;
            const tolerance = Math.min(60000, durationMs * 0.25);
            return Math.abs(valueMs - lastClosedStart) <= tolerance;
        }
    </script>
{% endblock %}

