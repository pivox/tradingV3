{% extends 'base.html.twig' %}

{% block title %}Dashboard MTF - Trading{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12 d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="bi bi-speedometer2"></i> Dashboard MTF</h1>
        <div>
            <span class="badge bg-secondary" id="lastUpdate">Chargement...</span>
        </div>
    </div>
</div>

<!-- Informations générales -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Mode:</strong> <span id="summaryMode">-</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Timeframe de départ:</strong> <span id="summaryStartFrom">-</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Généré à:</strong> <span id="summaryGeneratedAt">-</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Auto-refresh:</strong> <span class="badge bg-success">30s</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section Summary - Tableau détaillé -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-table"></i> Summary détaillé</h6>
            </div>
            <div class="card-body">
                <div id="summaryLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2">Chargement des données...</p>
                </div>
                <div id="summaryContent" style="display: none;">
                    <!-- With Trades -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-check-circle text-success"></i> 
                            Symboles avec trades (<span id="countWithTrades">0</span>)
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="tableWithTrades">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Symbole</th>
                                        <th>Side</th>
                                        <th>Status</th>
                                        <th>Trace ID</th>
                                        <th>Dernier événement</th>
                                        <th>Date dernier événement</th>
                                        <th>Dernier TF</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyWithTrades">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Aucune donnée</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Ready No Trade -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-hourglass-split text-warning"></i> 
                            Ready mais pas de trade (<span id="countReadyNoTrade">0</span>)
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="tableReadyNoTrade">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Symbole</th>
                                        <th>Side</th>
                                        <th>Dernier TF</th>
                                        <th>Raison</th>
                                        <th>Date raison</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyReadyNoTrade">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Aucune donnée</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Blocked by TF -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-x-circle text-danger"></i> 
                            Bloqués par timeframe
                        </h5>
                        <div id="blockedByTfContainer">
                            <!-- Les sections par TF seront générées dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
(function() {
    let refreshInterval = null;

    function formatDate(dateString) {
        if (!dateString) return '-';
        if (dateString === null || dateString === undefined) return '-';
        
        try {
            const date = new Date(dateString);
            // Vérifier si la date est valide
            if (isNaN(date.getTime())) {
                return '-';
            }
            return date.toLocaleString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (e) {
            return '-';
        }
    }

    function loadSummary() {
        fetch('{{ path('mtf_dashboard_summary') }}')
            .then(response => response.json())
            .then(data => {
                // Mettre à jour les informations générales
                document.getElementById('summaryMode').textContent = data.mode || '-';
                document.getElementById('summaryStartFrom').textContent = data.start_from_timeframe || '-';
                document.getElementById('summaryGeneratedAt').textContent = formatDate(data.generated_at);
                document.getElementById('lastUpdate').textContent = 'Dernière mise à jour: ' + formatDate(data.generated_at);

                // With Trades
                const withTrades = data.with_trades || [];
                document.getElementById('countWithTrades').textContent = withTrades.length;
                const tbodyWithTrades = document.getElementById('tbodyWithTrades');
                if (withTrades.length === 0) {
                    tbodyWithTrades.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Aucune donnée</td></tr>';
                } else {
                    tbodyWithTrades.innerHTML = withTrades.map(item => `
                        <tr>
                            <td>${item.id || '-'}</td>
                            <td><strong>${item.symbol || '-'}</strong></td>
                            <td><span class="badge ${item.side === 'LONG' ? 'bg-success' : 'bg-danger'}">${item.side || '-'}</span></td>
                            <td>${item.status || '-'}</td>
                            <td><code class="text-primary">${item.trace_id || '-'}</code></td>
                            <td>${item.last_event || '-'}</td>
                            <td>${formatDate(item.last_event_at)}</td>
                            <td><span class="badge bg-info">${item.last_tf || '-'}</span></td>
                        </tr>
                    `).join('');
                }

                // Ready No Trade
                const readyNoTrade = data.ready_no_trade || [];
                document.getElementById('countReadyNoTrade').textContent = readyNoTrade.length;
                const tbodyReadyNoTrade = document.getElementById('tbodyReadyNoTrade');
                if (readyNoTrade.length === 0) {
                    tbodyReadyNoTrade.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Aucune donnée</td></tr>';
                } else {
                    tbodyReadyNoTrade.innerHTML = readyNoTrade.map(item => `
                        <tr>
                            <td>${item.id || '-'}</td>
                            <td><strong>${item.symbol || '-'}</strong></td>
                            <td><span class="badge ${item.side === 'LONG' ? 'bg-success' : 'bg-danger'}">${item.side || '-'}</span></td>
                            <td><span class="badge bg-info">${item.last_tf || '-'}</span></td>
                            <td>${item.reason || '-'}</td>
                            <td>${formatDate(item.reason_at)}</td>
                        </tr>
                    `).join('');
                }

                // Blocked by TF
                const blockedByTf = data.blocked_by_tf || {};
                const blockedContainer = document.getElementById('blockedByTfContainer');
                const timeframes = ['4h', '1h', '15m', '5m', '1m'];
                blockedContainer.innerHTML = timeframes.map(tf => {
                    const items = blockedByTf[tf] || [];
                    if (items.length === 0) return '';
                    return `
                        <div class="mb-3">
                            <h6 class="text-muted">Bloqués à ${tf} (<span class="badge bg-secondary">${items.length}</span>)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Symbole</th>
                                            <th>Dernier TF</th>
                                            <th>TF manquant</th>
                                            <th>K4h Time</th>
                                            <th>K1h Time</th>
                                            <th>K15m Time</th>
                                            <th>K5m Time</th>
                                            <th>K1m Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${items.map(item => `
                                            <tr>
                                                <td>${item.id || '-'}</td>
                                                <td><strong>${item.symbol || '-'}</strong></td>
                                                <td><span class="badge bg-warning">${item.last_tf || '-'}</span></td>
                                                <td><span class="badge bg-danger">${item.missing_tf || '-'}</span></td>
                                                <td>${formatDate(item.k4h_time)}</td>
                                                <td>${formatDate(item.k1h_time)}</td>
                                                <td>${formatDate(item.k15m_time)}</td>
                                                <td>${formatDate(item.k5m_time)}</td>
                                                <td>${formatDate(item.k1m_time)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }).filter(html => html !== '').join('') || '<p class="text-muted">Aucun symbole bloqué</p>';

                // Afficher le contenu
                document.getElementById('summaryLoading').style.display = 'none';
                document.getElementById('summaryContent').style.display = 'block';
            })
            .catch(error => {
                console.error('Erreur lors du chargement du summary:', error);
                document.getElementById('summaryLoading').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Erreur lors du chargement des données: ${error.message}
                    </div>
                `;
            });
    }

    // Charger au démarrage
    loadSummary();

    // Auto-refresh toutes les 30 secondes
    refreshInterval = setInterval(loadSummary, 30000);

    // Nettoyer l'intervalle si la page est fermée
    window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
})();
</script>
{% endblock %}

