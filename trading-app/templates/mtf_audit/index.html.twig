{% extends 'base.html.twig' %}

{% block title %}Audits MTF - Trading{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-clipboard-data"></i> Audits MTF
            </h1>
            <div>
                <button class="btn btn-primary" onclick="refreshTable()">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filtres -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-funnel"></i> Filtres
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <label for="filterSymbol" class="form-label">Symbole</label>
                        <input type="text" class="form-control" id="filterSymbol" placeholder="Ex: BTCUSDT">
                    </div>
                    <div class="col-md-3">
                        <label for="filterStep" class="form-label">Étape (contient)</label>
                        <input type="text" class="form-control" id="filterStep" placeholder="Ex: validation, alignment, ...">
                    </div>
                    <input type="hidden" id="filterRunId" value="{{ runId ?? '' }}">
                    <div class="col-md-2">
                        <label for="filterDateFrom" class="form-label">Date Début</label>
                        <input type="date" class="form-control" id="filterDateFrom">
                    </div>
                    <div class="col-md-2">
                        <label for="filterDateTo" class="form-label">Date Fin</label>
                        <input type="date" class="form-control" id="filterDateTo">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Effacer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table des audits -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-table"></i> Liste des Audits MTF ({{ audits|length }})
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="auditsTable" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Symbole</th>
                                <th>Étape</th>
                                <th>TF</th>
                                <th>Cause</th>
                                <th>Détails</th>
                                <th>Créé le</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les détails -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Détails de l'Audit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="detailsContent" class="bg-light p-3"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
$(document).ready(function() {
    // Initialisation de DataTables
    $('#auditsTable').DataTable({
        processing: true,
        serverSide: true,
        pageLength: 25,
        order: [[6, 'desc']],
        ajax: {
            url: '{{ path('mtf_audit_data') }}',
            data: function(d) {
                d.symbol = $('#filterSymbol').val();
                d.step = $('#filterStep').val();
                d.date_from = $('#filterDateFrom').val();
                d.date_to = $('#filterDateTo').val();
                const rid = $('#filterRunId').val();
                if (rid) d.run_id = rid;
            }
        },
        columns: [
            { data: 'id', render: function(data){ return `<code>${data}</code>`; } },
            { data: 'symbol', render: function(data){ return `<strong>${data}</strong>`; } },
            { data: 'step', render: function(data){ return `<span class="badge bg-secondary">${data||''}</span>`; } },
            { data: 'timeframe', render: function(data){ return data ? `<span class="badge bg-primary">${data}</span>` : '<span class="text-muted">-</span>'; } },
            { data: 'cause', defaultContent: '-', render: function(data){ return data || '-'; } },
            { data: 'has_details', orderable: false, searchable: false, render: function(val, type, row){
                if (val) {
                    return `<button class="btn btn-sm btn-outline-info" onclick="viewDetails(${row.id})"><i class=\"bi bi-eye\"></i> Voir</button>`;
                }
                return '<span class="text-muted">-</span>';
            } },
            { data: 'created_at' },
            { data: null, orderable: false, searchable: false, render: function(row){
                const graphUrl = '{{ path('graph_index') }}' + '?symbol=' + encodeURIComponent(row.symbol);
                return `
                    <div class="btn-group btn-group-sm" role="group">
                        <a class="btn btn-outline-primary" href="${graphUrl}" title="Voir graphique"><i class="bi bi-graph-up"></i></a>
                        <button class="btn btn-outline-info" onclick="viewDetails(${row.id})" title="Voir détails"><i class="bi bi-eye"></i></button>
                    </div>`;
            }},
        ],
        columnDefs: [
            { orderable: false, targets: [5, 7] }
        ]
    });

    // Filtres
    $('#filterSymbol, #filterStep, #filterDateFrom, #filterDateTo').on('change keyup', function() {
        $('#auditsTable').DataTable().ajax.reload();
    });
});

function applyFilters() { $('#auditsTable').DataTable().ajax.reload(); }

function clearFilters() {
    $('#filterSymbol, #filterAction, #filterDateFrom, #filterDateTo').val('');
    $('#auditsTable').DataTable().search('').columns().search('').draw();
}

function refreshTable() {
    location.reload();
}

function viewChart(symbol) {
    // Rediriger vers les graphiques avec le symbole
    window.location.href = '{{ path('graph_index') }}?symbol=' + symbol;
}

async function viewDetails(id) {
    const detailsContent = document.getElementById('detailsContent');
    detailsContent.textContent = 'Chargement...';

    try {
        const resp = await fetch(`{{ path('mtf_audit_details', {id: 0}) | replace({'0':'__ID__'}) }}`.replace('__ID__', id));
        if (!resp.ok) {
            throw new Error('Erreur de chargement');
        }
        const data = await resp.json();
        detailsContent.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
        detailsContent.textContent = 'Impossible de charger les détails.';
    }

    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    modal.show();
}
</script>
{% endblock %}
