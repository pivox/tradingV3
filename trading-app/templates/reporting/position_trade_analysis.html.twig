{% extends 'base.html.twig' %}

{% block title %}Reporting - Position Trade Analysis{% endblock %}

{% block body %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3">
            <i class="bi bi-kanban"></i> Position Trade Analysis
        </h1>
    </div>

    <div class="alert alert-info">
        <p class="mb-1"><strong>Descriptif :</strong> vue SQL mixant entrées/sorties et snapshots indicateurs (position_trade_analysis).</p>
        <p class="mb-0"><strong>Exemple :</strong> filtrez par symbole (ex: <code>AIXBTUSDT</code>) et date d’entrée pour comparer le R attendu vs le PnL réel.</p>
    </div>

    <form method="get" class="row g-3 mb-4">
        <div class="col-md-3">
            <label for="symbol" class="form-label">Symbole</label>
            <input type="text" class="form-control" id="symbol" name="symbol" value="{{ filters.symbol ?? '' }}">
        </div>
        <div class="col-md-2">
            <label for="timeframe" class="form-label">Timeframe</label>
            <input type="text" class="form-control" id="timeframe" name="timeframe" value="{{ filters.timeframe ?? '' }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">Du (UTC)</label>
            <input type="date" class="form-control" name="from" value="{{ filters.from ?? '' }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">Au (UTC)</label>
            <input type="date" class="form-control" name="to" value="{{ filters.to ?? '' }}">
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-arrow-clockwise"></i> Filtrer
            </button>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>
                        <a href="{{ path('reporting_position_trade_analysis', app.request.query.all | merge({'sort': 'entryTime', 'direction': direction == 'ASC' and sort == 'entryTime' ? 'DESC' : 'ASC'})) }}">
                            Entrée
                        </a>
                    </th>
                    <th>Sortie</th>
                    <th>Symbole</th>
                    <th>TF</th>
                    <th>R attendu</th>
                    <th>R réalisé</th>
                    <th>PnL USDT</th>
                    <th>MFE/MAE (%)</th>
                    <th>RSI/ATR (entrée)</th>
                    <th>MA/VWAP</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in trades %}
                    <tr>
                        <td>
                            <div class="text-monospace">{{ trade.entryTime ? trade.entryTime|date('Y-m-d H:i:s') : '—' }}</div>
                        </td>
                        <td>
                            <div class="text-monospace">{{ trade.closeTime ? trade.closeTime|date('Y-m-d H:i:s') : '—' }}</div>
                        </td>
                        <td>{{ trade.symbol }}</td>
                        <td>{{ trade.timeframe }}</td>
                        <td class="text-muted">{{ trade.expectedRMultiple ?? '—' }}</td>
                        <td class="{{ trade.pnlR is not null and trade.pnlR < 0 ? 'text-danger' : 'text-success' }}">
                            {{ trade.pnlR ?? '—' }}
                        </td>
                        <td class="{{ trade.pnlUsdt is not null and trade.pnlUsdt < 0 ? 'text-danger' : 'text-success' }}">
                            {{ trade.pnlUsdt ?? '—' }}
                        </td>
                        <td>
                            <div>MFE {{ trade.mfePct ?? '—' }}%</div>
                            <div>MAE {{ trade.maePct ?? '—' }}%</div>
                        </td>
                        <td>
                            <div>RSI {{ trade.entryRsi ?? '—' }}</div>
                            <div>ATR {{ trade.entryAtr ?? '—' }}</div>
                        </td>
                        <td>
                            <div>MA9 {{ trade.entryMa9 ?? '—' }}</div>
                            <div>MA21 {{ trade.entryMa21 ?? '—' }}</div>
                            <div>VWAP {{ trade.entryVwap ?? '—' }}</div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted">Aucun trade trouvé avec ces filtres.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
