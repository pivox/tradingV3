# Configuration Indicator
# Sections extraites de trading.yml et organisées par fonctionnalité

indicator:
    # ======== INDICATORS ========
    # ✅ UTILISÉES: TradingConfigService::getIndicatorsConfig()
    indicators:
        ema:
            fast: 20
            mid: 50
            trend: 200
            pullback_fast: 9                   # pour détection pullback
            pullback_mid: 21                   # "MA21" implémentée en EMA(21)
        macd:
            fast: 12
            slow: 26
            signal: 9
        vwap:
            daily: true
            timezone: 'UTC'
        rsi:
            period: 14
            source: close
        meta: >
            EMA(20/50/200) pour structure, EMA(9/21) pour pullback, MACD (12,26,9) pour momentum,
            VWAP daily pour repère intraday, RSI(14) pour filtrage de timing.

    # ======== ATR ========
    # ✅ UTILISÉES: TradingConfigService::getAtrConfig()
    atr:
        period: 14
        method: wilder
        timeframe: '5m'
        sl_multiplier: 1.5                   # SL = k * ATR
        r_multiple: 2.0
        # Seuils ATR/close par timeframe pour atr_volatility_ok
        pct_thresholds:
            '1m': { min: 0.0010, max: 0.0300 }
            '5m': { min: 0.0010, max: 0.0300 }
            '15m': { min: 0.0015, max: 0.0300 }
            '1h': { min: 0.0008, max: 0.0250 }
            '4h': { min: 0.0005, max: 0.0200 }
        meta: >
            ATR(5m) pour le stop et le R-multiple. SL initial = 1.5x ATR, TP = 2R.
            Seuils ATR/close par timeframe pour validation de volatilité.

    # ======== INDICATOR CALCULATION MODE ========
    # ✅ UTILISÉES: TradingConfigService::getIndicatorCalculationConfig()
    calculation:
        mode: php                            # 'php' ou 'sql'
        fallback_to_php: true                # fallback vers PHP si SQL échoue
        performance_threshold_ms: 10        # seuil de performance pour switch automatique
        meta: >
            Mode de calcul des indicateurs: 'sql' utilise les vues matérialisées PostgreSQL,
            'php' utilise les calculs en mémoire. Fallback automatique si SQL échoue.

    # ======== VALIDATION RULES ========
    # ✅ UTILISÉES: ConditionRegistry via IndicatorConfig
    # Règles de validation MTF déplacées depuis src/MtfValidator/config/validations.yaml
    rules:
        # --- MACD / RSI / EMA de base (inchangés ou consolidés) ---
        macd_hist_gt_eps:
            op: '>'
            left: 'macd_hist'
            right: 0.0
            eps: 1.0e-6

        ema20_over_50_with_tolerance:
            any_of:
                - ema_20_gt_50
                -   ema_20_minus_ema_50_gt: -0.0012   # +50% de tolérance (Option 2)
                - ema_20_slope_pos                  # Nouvelle condition : pente positive

        ema_above_200_with_tolerance:
            any_of:
                - close_above_ema_200
                -   close_minus_ema_200_gt: -0.0030
                - ema200_slope_pos                   # Nouvelle condition : pente positive

        ema_below_200_with_tolerance:
            any_of:
                - close_below_ema_200
                -   close_minus_ema_200_lt: -0.0025   # < -0,25 % (augmenté pour équilibrer)
                - ema200_slope_neg                   # Nouvelle condition : pente négative

        rsi_lt_softcap: { lt: 78 }
        rsi_gt_softfloor: { gt: 30 }
        rsi_lt_70: { lt: 70 }

        close_above_vwap_or_ma9:
            any_of: [ close_above_vwap, close_above_ma_9 ]

        price_below_ma21_plus_2atr:
            lt_fields: [ 'close', 'ma_21_plus_2atr' ]
            allow_touch: true                    # tolère un léger dépassement (anti faux négatifs)

        pullback_confirmed:
            any_of:
                - ma9_cross_up_ma21
                -   near_vwap: true
            validity_bars: 3

        # --- Anti-bruit MACD : hystérésis & slope au lieu de monotonie stricte ---
        macd_line_cross_up_with_hysteresis:
            require_prev_below: true
            min_gap: 0.0008
            cool_down_bars: 2

        macd_line_cross_down_with_hysteresis:
            require_prev_above: true
            min_gap: 0.0015          # Augmenté de 0.0003 à 0.0015 (0.15%)
            cool_down_bars: 4        # Augmenté de 2 à 4 barres

        macd_hist_slope_pos:
            derivative_gt: 0.0       # pente > 0
            persist_n: 2             # 2 barres consécutives (pas besoin "increasing" strict)

        macd_hist_slope_neg:
            derivative_lt: 0.0
            persist_n: 2

        # --- Slope EMA200 adoucie (plus stable) ---
        ema200_slope_pos:
            slope_left: 'ema_200'
            slope_lookback: 13
            op: '>'
            right: 0.0
            eps: 1.0e-12

        ema200_slope_neg:
            slope_left: 'ema_200'
            slope_lookback: 21       # moyenne de pente plus longue
            op: '<'
            right: 0.0
            eps: 1.0e-12

        # --- ATR adaptatif (15m/5m) : plage élargie + buckets de volatilité ---
        atr_rel_in_range_15m:
            use_atr_tf: [ '1m', '5m' ]    # choisit la plus stable selon la vol
            min: 0.0015                   # élargi encore plus (0.15%)
            max: 0.035                    # élargi encore plus (3.5%)
            adapt_with_vol_bucket: true   # élargir en high-vol, resserrer en low-vol

        atr_rel_in_range_5m:
            use_atr_tf: [ '1m' ]
            min: 0.0010                   # élargi encore plus (0.10%)
            max: 0.040                    # élargi encore plus (4.0%)
            adapt_with_vol_bucket: true

        # --- Compat : règles existantes (toujours disponibles si référencées) ---
        macd_line_below_signal:
            lt_fields: [ 'macd', 'macd_signal' ]

        # ===== DRAFT OPTIONS (À TESTER SI NÉCESSAIRE) =====
        # Option 2 : Tolérance Modérée (ACTIVÉE)
        ema20_over_50_with_tolerance_moderate:
            any_of:
                - ema_20_gt_50
                -   ema_20_minus_ema_50_gt: -0.0012   # +50% de tolérance
                - ema_20_slope_pos

        ema_above_200_with_tolerance_moderate:
            any_of:
                - close_above_ema_200
                -   close_minus_ema_200_gt: -0.0020   # +33% de tolérance
                - ema200_slope_pos

        macd_line_above_signal:
            gt_fields: [ 'macd', 'macd_signal' ]

        macd_hist_increasing_n:
            increasing: { field: 'macd_hist', n: 2 }

        macd_hist_decreasing_n:
            decreasing: { field: 'macd_hist', n: 2 }
    validation:
        # ⚠️ UTILISÉES INDIRECTEMENT: Utilisées via MtfValidationConfig::getValidation()
        timeframe:
            '4h': # Contexte / structure (durci : structure de base requise)
                long:
                    -   all_of: # structure : exiger la structure de base OU tolérance + confirmation
                            -   any_of:
                                    -   all_of: [ ema_50_gt_200, close_above_ema_200 ]  # structure stricte
                                    -   all_of: [ ema_above_200_with_tolerance, ema_50_gt_200 ]  # tolérance + confirmation
                            - price_regime_ok_long
                short:
                    -   all_of: # structure : exiger la structure de base OU tolérance + confirmation
                            -   any_of:
                                    -   all_of: [ ema_50_lt_200, close_below_ema_200 ]  # structure stricte
                                    -   all_of: [ ema_below_200_with_tolerance, ema_50_lt_200 ]  # tolérance + confirmation
                            - price_regime_ok_short

            '1h': # Biais + momentum (durci : structure + momentum requis)
                long:
                    -   all_of: # structure : exiger structure ET momentum
                            -   any_of:
                                    -   all_of: [ ema_above_200_with_tolerance, ema_50_gt_200 ]
                                    -   all_of: [ ema200_slope_pos, ema_50_gt_200 ]
                            -   any_of: # momentum : au moins 1 condition forte
                                    -   all_of: [ macd_hist_gt_eps ]
                                    -   all_of: [ macd_line_cross_up_with_hysteresis ]
                                    -   all_of: [ macd_hist_slope_pos ]
                    - price_regime_ok_long

                short:
                    -   all_of: # structure : exiger structure ET momentum
                            -   any_of:
                                    -   all_of: [ ema_below_200_with_tolerance, ema_50_lt_200 ]
                                    -   all_of: [ ema200_slope_neg, ema_50_lt_200 ]
                            -   any_of: # momentum : au moins 1 condition forte
                                    -   all_of: [ macd_line_cross_down_with_hysteresis ]
                                    -   all_of: [ macd_hist_decreasing_n ]
                                    -   all_of: [ macd_hist_slope_neg ]
                    - price_regime_ok_short

            '15m': # Exécution / timing (durci : multi-conditions requises)
                long:
                    -   all_of: # Toutes les conditions doivent être remplies
                            -   any_of:
                                    -   all_of: [ macd_hist_gt_eps, ema20_over_50_with_tolerance ]
                                    -   all_of: [ macd_line_cross_up_with_hysteresis, close_above_vwap_or_ma9 ]
                            - ema20_over_50_with_tolerance  # Structure EMA requise
                            - rsi_lt_70  # RSI non surchauffé
                            - close_above_vwap_or_ma9  # Prix au-dessus du support
                            - atr_volatility_ok  # Volatilité ATR dans une fourchette exploitable
                short:
                    -   all_of: # Toutes les conditions doivent être remplies
                            -   any_of:
                                    -   all_of: [ macd_line_cross_down_with_hysteresis ]
                                    -   all_of: [ macd_hist_decreasing_n, ema_20_lt_50 ]
                            - ema_20_lt_50  # Structure EMA requise
                            - rsi_gt_softfloor  # RSI non survendu
                            - close_below_vwap  # Prix sous VWAP côté short
                            - atr_volatility_ok  # Volatilité ATR dans une fourchette exploitable

            '5m': # Finesse d'entrée (durci : multi-conditions requises)
                long:
                    -   all_of: # Toutes les conditions doivent être remplies
                            -   any_of:
                                    -   all_of: [ macd_hist_gt_eps, ema20_over_50_with_tolerance ]
                                    -   all_of: [ macd_line_cross_up_with_hysteresis, close_above_vwap_or_ma9 ]
                            - ema20_over_50_with_tolerance  # Structure EMA requise
                            - close_above_vwap_or_ma9  # Prix au-dessus du support
                            - rsi_lt_70  # RSI non surchauffé
                            - atr_volatility_ok  # Volatilité ATR dans une fourchette exploitable
                short:
                    -   all_of: # Toutes les conditions doivent être remplies
                            -   any_of:
                                    -   all_of: [ macd_line_cross_down_with_hysteresis ]
                                    -   all_of: [ macd_hist_decreasing_n, ema_20_lt_50 ]
                            - ema_20_lt_50  # Structure EMA requise
                            - rsi_gt_softfloor  # RSI non survendu
                            - close_below_vwap  # Prix sous VWAP côté short
                            - atr_volatility_ok  # Volatilité ATR dans une fourchette exploitable

            '1m': # Micro-timing (durci : multi-conditions requises)
                long:
                    -   all_of: # Toutes les conditions doivent être remplies
                            - macd_hist_gt_eps  # Momentum MACD positif
                            - ema20_over_50_with_tolerance  # Structure EMA requise
                            - close_above_vwap_or_ma9  # Prix au-dessus du support
                            - rsi_lt_70  # RSI non surchauffé
                            - macd_hist_slope_pos  # Momentum en accélération
                            - atr_volatility_ok    # Volatilité ATR dans une fourchette exploitable
                short:
                    -   all_of: # Toutes les conditions doivent être remplies
                            - macd_hist_decreasing_n  # Momentum MACD négatif
                            - ema_20_lt_50  # Structure EMA requise
                            - rsi_gt_softfloor  # RSI non survendu
                            - close_below_vwap      # Prix sous VWAP côté short
                            - macd_hist_slope_neg   # Momentum en accélération
                            - atr_volatility_ok     # Volatilité ATR dans une fourchette exploitable

