# =====================================================================
# trade_entry.crash.yaml – Profil CRASH
# Shorts en régime baissier + dumps violents
# =====================================================================
version: '1.0.0'

meta:
    name: >
        CRASH SHORT v1.0 – Trend Baissier + Dumps Violents
    description: >
        Profil dédié aux shorts en régime baissier structuré (4h/1h) avec gestion prudente du risque
        et des entrées pendant les phases de dump. À utiliser séparément du profil SCALPER.

trade_entry:

    # ============================
    # DEFAULTS
    # ============================
    defaults:
        risk_pct_percent: 1.5           # Risque nominal par trade (plus bas que scalper)
        initial_margin_usdt: 20.0
        fallback_account_balance: 0.0

        # --- R-MULTIPLE / TP
        r_multiple: 1.0                 # R attendu modeste (on vise du "panic flush")
        tp1_r: 0.8                      # TP1 un peu plus proche (verrouiller vite)

        # --- STOP LOSS
        stop_from: 'pivot'              # Stop sur pivot / structure locale
        stop_fallback: 'atr'            # Fallback lorsque pivot trop éloigné ('atr','risk','none')
        atr_k: 1.5                      # ATR pour cadrer la distance
        # pivot_sl_policy: 'nearest' → résistance la plus proche côté short (levier ↑). 'strongest' favorise R2/R1 → stop plus haut, levier ↓.
        pivot_sl_policy: 'nearest'  # en short : pivot au-dessus
        pivot_sl_buffer_pct: 0.003
        pivot_sl_min_keep_ratio: 0.8
        sl_full_size: true              # SL sur la taille totale (règle sécurité)

        # --- TAKE PROFIT
        tp_policy: 'pivot_conservative'
        tp_buffer_pct: 0.001
        tp_buffer_ticks: 0
        tp_min_keep_ratio: 0.95
        tp_max_extra_r: 0.5

        # --- ORDERS
        order_type: 'limit'
        open_type: 'isolated'
        order_mode: 1                   # Maker-only si possible

        # --- MARKET GUARDS
        market_max_spread_pct: 0.001
        inside_ticks: 1

        # Déviations : un peu plus tolérant que scalper, car le marché bouge vite en crash
        max_deviation_pct: 0.004        # Déviation max autorisée vs mark
        implausible_pct: 0.03           # Garde-fou mouvements irrationnels
        zone_max_deviation_pct: 0.03    # Max deviation entre prix & EntryZone

        # --- DYNAMIC LEVERAGE PARAM (même logique globale que scalper)
        k_dynamic: 10.0


    # ============================
    # RISK MANAGEMENT
    # ============================
    risk:
        fixed_risk_pct: 1.5             # Plus bas que scalper (2.0) pour crash
        daily_max_loss_pct: 4.0         # DD journalier plus serré
        daily_max_loss_usdt: 30.0
        daily_loss_count_unrealized: true
        max_concurrent_positions: 4     # Moins de positions simultanées

        crash_mode:
            enabled: true
            # Tu pourras utiliser un flag de contexte (ex: is_crash_mode=true)
            # pour appliquer un sous-profil encore plus conservateur si besoin.
            risk_pct_multiplier: 0.75   # 1.5% → 1.125% si crash_mode flag actif
            tp1_r: 0.7                  # TP1 encore plus proche
            hard_time_stop_min: 45      # Time stop rigide en minutes

        meta: >
            Gestion du risque prudente pour des situations de volatilité élevée et de panic sell.
            Moins de positions, risque réduit et time-stop plus strict.


    # ============================
    # LEVERAGE CONFIG
    # ============================
    leverage:
        mode: dynamic_from_risk
        floor: 3.0                # Plancher un peu plus bas (moins agressif)
        exchange_cap: 40.0        # Cap global plus modéré qu'en scalper

        per_symbol_caps:
            - { symbol_regex: "^BTCUSDT$", cap: 30.0 }
            - { symbol_regex: "^(ETH|BNB)USDT$", cap: 20.0 }
            - { symbol_regex: "^(NVDAXUSDT|1000RATSUSDT)$", cap: 4.0 }

        timeframe_multipliers:
            '4h': 0.8
            '1h': 0.9
            '15m': 1.0
            '5m': 1.1
            '1m': 1.2

        confidence_multiplier:
            enabled: true
            default: 1.0
            when_upstream_stale: 0.8
            when_tie_breaker_used: 0.8

        conviction:
            enabled: true
            cap_pct_of_exchange: 0.60

        rounding:
            precision: 2
            mode: floor

        meta: >
            Levier dérivé du risque / stop, plafonné de manière plus stricte pour un environnement de crash.


    # ============================
    # DECISION ENGINE
    # ============================
    decision:
        allowed_execution_timeframes: []   # laisse le MTF choisir (15m/5m/1m)
        require_price_or_atr: true


    # ============================
    # END-OF-ZONE FALLBACK
    # ============================
    fallback_end_of_zone:
        enabled: true                      # utile en crash (prix traverse vite la zone)
        ttl_threshold_sec: 25
        max_spread_bps: 8
        only_if_within_zone: true
        taker_order_type: 'market'
        max_slippage_bps: 10


    # ============================
    # MARKET ENTRY (Taker)
    # ============================
    market_entry:
        enabled: true
        allowed_execution_timeframes: ['1m','5m']
        max_slippage_bps: 25
        adx_min_1h: 15


    # ============================
    # ENTRY CONFIG (limit + guards)
    # ============================
    entry:
        prefer_maker: true
        fallback_taker: true

        budget:
            mode: fixed_or_available
            fixed_usdt_if_available: 40

        quantization:
            price_tick: from_exchange
            qty_step: from_exchange

        slippage_guard_bps: 10          # un peu plus tolérant que scalper
        spread_guard_bps: 8

        meta: >
            Entrée en priorité en maker dans la zone, avec fallback taker contrôlé.
            Légèrement plus permissif que scalper pour tenir compte de la vitesse d'un crash.


    # ============================
    # POST-VALIDATION (EntryZone)
    # ============================
    post_validation:

        entry_zone:
            vwap_anchor: true
            k_atr: 0.25                  # Zone légèrement plus large que scalper
            w_min: 0.0005
            w_max: 0.0080
            quantize_to_exchange_step: true
            ttl_sec: 120                 # Zone un peu plus courte (dump rapide)

        idempotency:
            decision_key_tpl: "{symbol}:{timeframe}:{candle_open_ts}"
            max_attempts: 3

        meta: >
            EntryZone légèrement élargie pour les crashes, mais toujours encadrée
            par des garde-fous sur la déviation et le slippage.
