mtf_validation:
    rules:
        # --- MACD / RSI / EMA de base (inchangés ou consolidés) ---
        macd_hist_gt_eps:
            op: '>'
            left: 'macd_hist'
            right: 0.0
            eps: 1.0e-6

        ema20_over_50_with_tolerance:
            any_of:
                - ema_20_gt_50
                - ema_20_minus_ema_50_gt: -0.0008   # -0,08 % toléré

        ema_above_200_with_tolerance:
            any_of:
                - close_above_ema_200
                - close_minus_ema_200_gt: -0.0030   # -0,30 % toléré

        ema_below_200_with_tolerance:
            any_of:
                - close_below_ema_200
                - close_minus_ema_200_lt: -0.0015   # < -0,15 %

        rsi_lt_softcap: { lt: 78 }
        rsi_gt_softfloor: { gt: 30 }
        rsi_lt_70: { lt: 70 }

        close_above_vwap_or_ma9:
            any_of: [ close_above_vwap, close_above_ma_9 ]

        price_below_ma21_plus_2atr:
            lt_fields: [ 'close', 'ma_21_plus_2atr' ]
            allow_touch: true                    # tolère un léger dépassement (anti faux négatifs)

        pullback_confirmed:
            any_of:
                - ma9_cross_up_ma21
                - near_vwap: true
            validity_bars: 3

        # --- Anti-bruit MACD : hystérésis & slope au lieu de monotonie stricte ---
        macd_line_cross_up_with_hysteresis:
            require_prev_below: true
            min_gap: 0.0003
            cool_down_bars: 2

        macd_line_cross_down_with_hysteresis:
            require_prev_above: true
            min_gap: 0.0003
            cool_down_bars: 2

        macd_hist_slope_pos:
            derivative_gt: 0.0       # pente > 0
            persist_n: 2             # 2 barres consécutives (pas besoin "increasing" strict)

        macd_hist_slope_neg:
            derivative_lt: 0.0
            persist_n: 2

        # --- Slope EMA200 adoucie (plus stable) ---
        ema200_slope_pos:
            slope_left: 'ema_200'
            slope_lookback: 21       # moyenne de pente plus longue
            op: '>'
            right: 0.0
            eps: 1.0e-12

        # --- ATR adaptatif (15m/5m) : plage élargie + buckets de volatilité ---
        atr_rel_in_range_15m:
            use_atr_tf: [ '1m', '5m' ]    # choisit la plus stable selon la vol
            min: 0.0025                   # élargi
            max: 0.025                    # élargi
            adapt_with_vol_bucket: true   # élargir en high-vol, resserrer en low-vol

        atr_rel_in_range_5m:
            use_atr_tf: [ '1m' ]
            min: 0.0020
            max: 0.030
            adapt_with_vol_bucket: true

        # --- Compat : règles existantes (toujours disponibles si référencées) ---
        macd_line_below_signal:
            lt_fields: [ 'macd', 'macd_signal' ]

        macd_line_above_signal:
            gt_fields: [ 'macd', 'macd_signal' ]

        macd_hist_increasing_n:
            increasing: { field: 'macd_hist', n: 2 }

        macd_hist_decreasing_n:
            decreasing: { field: 'macd_hist', n: 2 }

    validation:
        start_from_timeframe: '1h'

        timeframe:

            '4h':  # Contexte / structure
                long:
                    all_of:
                        - ema_50_gt_200
                        - close_above_ema_200
                        - price_regime_ok_long
                short:
                    all_of:
                        - ema_50_lt_200
                        - close_below_ema_200
                        - price_regime_ok_short

            '1h':  # Biais + momentum (adouci)
                long:
                    - any_of:     # structure : au moins 1 des 3
                          - all_of: [ ema_above_200_with_tolerance ]
                          - all_of: [ ema200_slope_pos ]         # pente ≥ 0 (lookback 21)
                          - all_of: [ ema_50_gt_200 ]
                    - any_of:     # momentum : anti-bruit
                          - all_of: [ macd_hist_gt_eps ]
                          - all_of: [ macd_line_cross_up_with_hysteresis ]
                          - all_of: [ macd_hist_slope_pos ]      # slope + persistance (= remplace monotonicité stricte)
                    - price_regime_ok_long

                short:
                    - ema_below_200_with_tolerance
                    - any_of:
                          - all_of: [ macd_line_cross_down_with_hysteresis ]
                          - all_of: [ macd_hist_slope_neg ]
                          - all_of: [ macd_hist_decreasing_n ]   # fallback compat
                    - price_regime_ok_short

            '15m':  # Exécution / timing (ATR élargi + anti-extension)
                long:
                    - any_of:
                          - all_of: [ ema20_over_50_with_tolerance, macd_hist_gt_eps ]
                          - all_of: [ ema20_over_50_with_tolerance, close_above_vwap_or_ma9 ]
                          - all_of: [ macd_hist_gt_eps, close_above_vwap_or_ma9 ]
                    - rsi_lt_70
                    - price_below_ma21_plus_2atr
                    - atr_rel_in_range_15m
                short:
                    - any_of:
                          - all_of: [ ema_20_lt_50, macd_line_cross_down_with_hysteresis ]
                          - all_of: [ macd_hist_slope_neg ]
                          - all_of: [ macd_hist_decreasing_n ]   # compat
                    - rsi_gt_softfloor
                    - atr_rel_in_range_15m

            '5m':   # Finesse d'entrée (pullback confirmé)
                long:
                    - any_of:
                          - all_of: [ ema20_over_50_with_tolerance, macd_hist_gt_eps ]
                          - all_of: [ ema20_over_50_with_tolerance, rsi_lt_softcap ]
                          - all_of: [ macd_hist_gt_eps, rsi_lt_softcap ]
                    - pullback_confirmed
                    - atr_rel_in_range_5m
                short:
                    - any_of:
                          - all_of: [ ema_20_lt_50, macd_line_cross_down_with_hysteresis ]
                          - all_of: [ macd_hist_slope_neg ]
                          - all_of: [ ema_20_lt_50, rsi_gt_softfloor ]
                    - atr_rel_in_range_5m

            '1m':   # Micro-timing (anti whipsaw + anti extension)
                long:
                    - all_of:
                          - ema_20_gt_50
                          - any_of:
                                - all_of: [ macd_hist_gt_eps ]
                                - all_of: [ macd_line_cross_up_with_hysteresis ]
                          - rsi_lt_80
                          - close_above_vwap_or_ma9
                          - price_below_ma21_plus_2atr
                short:
                    - all_of:
                          - ema_20_lt_50
                          - any_of:
                                - all_of: [ macd_line_cross_down_with_hysteresis ]
                                - all_of: [ macd_hist_slope_neg ]
                          - rsi_gt_softfloor
