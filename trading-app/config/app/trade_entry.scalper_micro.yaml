# =====================================================================
# trade_entry.scalper_micro.yaml – Mode micro-structure only
# Risque réduit, daily loss cap strict, nombre de trades limité
# =====================================================================
version: '0.1.4-micro-atr-5m'

meta:
    name: 'scalper_micro'
    description: >
        Scalping micro-structure (5m/1m) sans contexte 1h/4h, maintenant centré sur des
        entry zones serrées (w_max 0.014) avec tolérance runtime augmentée (zone_max_deviation_pct 12%,
        entry max_deviation_pct 15%) pour réduire les rejets entry_zone.rejected_by_deviation.
        Pivot: SMA21. ATR: 5m (au lieu de 1m) pour zone plus large et meilleure capture des prix.

trade_entry:

    # ============================
    # DEFAULTS
    # ============================
    defaults:
        # --- Sizing & Risk ---
        risk_pct_percent: 0.5             # 0.5 % du capital par trade
        initial_margin_usdt: 100.0         # budget réduit pour micro-structure
        fallback_account_balance: 0.0
        r_multiple: 1.2                   # TP resserré (profil micro)
        tp1_r: 1.2

        # --- Stop Loss ---
        stop_from: 'atr'
        stop_fallback: 'atr'
        atr_k: 4.0                        # stop ≈ 4 × ATR(1m) (distance ×2)
        # pivot_sl_policy: 'nearest' → support/résistance la plus proche (levier max). 'strongest' priorise S2/R2 → stop plus large, levier réduit.
        pivot_sl_policy: 'nearest'
        pivot_sl_buffer_pct: 0.003
        pivot_sl_min_keep_ratio: 0.85
        sl_full_size: true

        # --- Take Profit ---
        tp_policy: 'pivot_conservative'
        tp_buffer_pct: 0.001
        tp_buffer_ticks: 0
        tp_min_keep_ratio: 0.95
        tp_max_extra_r: 0.4

        # --- Order Preferences ---
        order_type: 'limit'
        open_type: 'isolated'
        order_mode: 1                     # micro scalper agit en taker par défaut

        # --- Market & Spread Guards ---
        market_max_spread_pct: 0.001
        inside_ticks: 1
        max_deviation_pct: 0.02
        implausible_pct: 0.05
        zone_max_deviation_pct: 0.12      # tolérance 12 % (augmentée pour réduire rejets runtime)

        # --- Leverage helper ---
        k_dynamic: 10.0

        # --- TF scaling ---
        timeframe_multipliers:
            '1m': 4

    # ============================
    # RISK MANAGEMENT
    # ============================
    risk:
        fixed_risk_pct: 0.5
        daily_max_loss_pct: 2.5
        daily_max_loss_usdt: 25.0
        daily_loss_count_unrealized: true
        max_concurrent_positions: 3
        meta: >
            Risque plus bas que le scalper principal, daily loss cap strict et
            limitation du nombre de trades simultanés.

    # ============================
    # LEVERAGE CONFIG
    # ============================
    leverage:
        mode: dynamic_from_risk
        floor: 2.0
        exchange_cap: 10.0
        per_symbol_caps: []
        timeframe_multipliers:
            '1m': 1.2
        confidence_multiplier:
            enabled: false
        conviction:
            enabled: false
        rounding:
            precision: 2
            mode: floor
        meta: >
            Levier plafonné à 10× (aligné avec max_leverage), sans boosts de conviction.

    # ============================
    # DECISION ENGINE
    # ============================
    decision:
        allowed_execution_timeframes: ['5m', '1m']
        require_price_or_atr: true

    # ============================
    # END-OF-ZONE FALLBACK
    # ============================
    fallback_end_of_zone:
        enabled: true
        ttl_threshold_sec: 25
        max_spread_bps: 8
        only_if_within_zone: true
        taker_order_type: 'market'
        max_slippage_bps: 10

    # ============================
    # ENTRY CONFIG
    # ============================
    entry:
        prefer_maker: true
        fallback_taker: true
        budget:
            mode: fixed_or_available
            fixed_usdt_if_available: 77
        quantization:
            price_tick: from_exchange
            qty_step: from_exchange
        slippage_guard_bps: 8
        spread_guard_bps: 6
        entry_zone:
            from: 'sma21'
            offset_atr_tf: '5m'
            offset_k: 2.0           # largeur de zone ~ 1 × ATR(5m)
            max_deviation_pct: 0.15  # tolérance 15 % (augmentée pour réduire rejets runtime)
            ttl_sec: 180
            quantize_to_exchange_step: true

    # ============================
    # POST-VALIDATION (EntryZone)
    # ============================
    post_validation:
        entry_zone:
            vwap_anchor: false
            k_atr: 0.35
            w_min: 0.0005
            w_max: 0.014
            ttl_sec: 240
            quantize_to_exchange_step: true
        idempotency:
            decision_key_tpl: "{symbol}:{timeframe}:{candle_open_ts}"
            max_attempts: 3
        meta: >
            Zone d'entrée courte, pure micro-structure autour de SMA21 (5m/1m).
