# Profil SCALPER - TradeEntry
version: '2.5.95s'

meta:
    name: >
        SCALPING v2.1 - Anti-Extension + Liquidité + Précision Zone
        => j'ai deserré zone_max_dev_pct à 0.02 pour éviter trop de rejets sur certains symbols (fixed_usdt_if_available)
    description: >
        Version optimisée du profil scalper : contrôle de liquidité, prévention des entrées tardives,
        réduction de la largeur des zones, levier réduit sur micro-caps, compatibilité MTF 1h→5m→1m.
    created_at: '2025-11-13'

trade_entry:

    # ============================
    # DEFAULTS
    # ============================
    defaults:
        risk_pct_percent: 5.0
        initial_margin_usdt: 70.0
        fallback_account_balance: 0.0

        # --- R-MULTIPLE corrigé (1.2 → 1.5)
        r_multiple: 1.5
        tp1_r: 1.3

        # --- STOP LOSS
        stop_from: 'atr'
        atr_k: 1.5
        pivot_sl_policy: 'nearest_below'
        pivot_sl_buffer_pct: 0.003
        pivot_sl_min_keep_ratio: 0.8
        sl_full_size: true

        # --- TAKE PROFIT
        tp_policy: 'pivot_conservative'
        tp_buffer_pct: 0.001
        tp_buffer_ticks: 0
        tp_min_keep_ratio: 0.95
        tp_max_extra_r: 0.5

        # --- ORDERS
        order_type: 'limit'
        open_type: 'isolated'
        order_mode: 1

        # --- MARKET GUARDS
        market_max_spread_pct: 0.001
        inside_ticks: 1

        # Déviations resserrées pour éviter les entrées en extension
        max_deviation_pct: 0.004
        implausible_pct: 0.02
        zone_max_deviation_pct: 0.02

        # --- DYNAMIC LEVERAGE PARAM
        k_dynamic: 10.0


    # ============================
    # RISK MANAGEMENT
    # ============================
    risk:
        fixed_risk_pct: 2.5
        daily_max_loss_pct: 6.0
        daily_max_loss_usdt: 30.0
        daily_loss_count_unrealized: true
        max_concurrent_positions: 4
        meta: >
            Risque fixe, limites journalières et contrôle du nombre de positions.


    # ============================
    # LEVERAGE CONFIG
    # ============================
    leverage:
        mode: dynamic_from_risk
        floor: 4.0                   # 5 → 4 pour réduire pertes micro-caps
        exchange_cap: 50.0           # réduit (micro-caps trop volatiles)

        per_symbol_caps:
            # BTC peut monter jusqu'à 40x
            - { symbol_regex: "^BTCUSDT$", cap: 40.0 }

            # ETH/BNB un peu en dessous : 25x par ex.
            - { symbol_regex: "^(ETH|BNB)USDT$", cap: 25.0 }

            # Certains shitcoins très volatils / illiquides : 5x
            - { symbol_regex: "^(NVDAXUSDT|1000RATSUSDT)$", cap: 5.0 }


        timeframe_multipliers:
            '4h': 0.9
            '1h': 1.0
            '15m': 1.0
            '5m': 1.2
            '1m': 1.3

        confidence_multiplier:
            enabled: true
            default: 1.0
            when_upstream_stale: 0.8
            when_tie_breaker_used: 0.8

        conviction:
            enabled: true
            cap_pct_of_exchange: 0.60

        rounding:
            precision: 2
            mode: floor

        meta: >
            Levier prudent, contrôlé, adapté aux fortes fluctuations sur tokens peu liquides.


    # ============================
    # DECISION ENGINE
    # ============================
    decision:
        # Note: allowed_execution_timeframes n'est plus utilisé pour CHOISIR le TF.
        # Le TF d'exécution est maintenant décidé par MtfService::ExecutionTimeframeDecisionService.
        # Si défini et non vide, cette liste sert uniquement de VALIDATION (rejette si le TF décidé n'est pas dans la liste).
        # Si vide ou non défini, tous les TF sont acceptés.
        allowed_execution_timeframes: []  # Vide = accepte tous les TF décidés par MtfService
        require_price_or_atr: true


    # ============================
    # END-OF-ZONE FALLBACK
    # ============================
    fallback_end_of_zone:
        enabled: true
        ttl_threshold_sec: 25
        max_spread_bps: 8
        only_if_within_zone: true
        taker_order_type: 'market'
        max_slippage_bps: 10


    # ============================
    # MARKET ENTRY (Taker)
    # ============================
    market_entry:
        enabled: true
        # Note: allowed_execution_timeframes dans market_entry sert uniquement de VALIDATION
        # pour décider si on peut utiliser un ordre market au lieu de limit.
        # Le TF d'exécution est déjà décidé par MtfService.
        allowed_execution_timeframes: ['1m','5m']  # Validation pour market entry uniquement
        max_slippage_bps: 25
        adx_min_1h: 15


    # ============================
    # ENTRY CONFIG
    # ============================
    entry:
        prefer_maker: true
        fallback_taker: true

        budget:
            mode: fixed_or_available
            fixed_usdt_if_available: 40

        quantization:
            price_tick: from_exchange
            qty_step: from_exchange

        slippage_guard_bps: 8
        spread_guard_bps: 6

        meta: >
            Budget et garde-fous de market microstructure adaptés aux scalps rapides.


    # ============================
    # POST-VALIDATION (EntryZone)
    # ============================
    post_validation:

        entry_zone:
            vwap_anchor: true
            k_atr: 0.24          # 0.30 → 0.24 → zones plus précises (meilleur winrate)
            w_min: 0.0004
            w_max: 0.0080        # 0.012 → 0.008 → évite entrées tardives
            quantize_to_exchange_step: true
            ttl_sec: 180         # 240 → 180 (aligné sur temps de vie d’un scalp)

        idempotency:
            decision_key_tpl: "{symbol}:{timeframe}:{candle_open_ts}"
            max_attempts: 3

        meta: >
            EntryZone resserrée, plus précise, moins permissive, cohérente avec le scalping pro.
