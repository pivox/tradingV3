# =====================================================================
# validations.scalper_micro.yaml – Profil SCALPER micro-structure only
# Version C : Bias 5m + timing 1m, long/short symétriques
# =====================================================================
version: '1.1.3-micro-macd-eps'

mtf_validation:
    mode: 'pragmatic'
    context_timeframes: ['5m']
    execution_timeframes: ['1m']
    execution_timeframe_default: '1m'
    allow_skip_lower_tf: false

    defaults:
        dry_run_validate_all_timeframes: false

    # ================================
    # FILTRES MANDATOIRES (MICRO ONLY)
    # ================================
    filters_mandatory: []
    # Garder vide : préférer des filtres intégrés aux scénarios (plus faciles à ajuster)

    # ================================
    # RÈGLES ATOMIQUES
    # ================================
    rules:
        # IMPORTANT : ce bloc reste nécessaire pour les combinaisons (any_of/all_of)
        # utilisées à la fois par l'engine ConditionRegistry et par le fallback YAML.

        # ====== VWAP / MA9 (structure) ======
        close_above_vwap:
            gt_fields: ['close', 'vwap']

        close_below_vwap:
            lt_fields: ['close', 'vwap']

        close_above_ma_9:
            gt_fields: ['close', 'ma_9']

        close_below_ma_9:
            lt_fields: ['close', 'ma_9']

        close_above_vwap_or_ma9:
            any_of: [close_above_vwap, close_above_ma_9]

        close_below_vwap_or_ma9:
            any_of: [close_below_vwap, close_below_ma_9]

        near_vwap:
            near_vwap: true

    # ================================
    # VALIDATION PAR TIMEFRAME
    # ================================
    validation:

        start_from_timeframe: '5m'

        timeframe:

            # -------------------------
            # 5m : CONTEXTE LOCAL
            # -------------------------
            '5m':
                long:
                    - all_of:
                          - ema20_over_50_with_tolerance_moderate
                          - close_above_vwap_or_ma9
                          - macd_hist_gt_eps: { eps: 1.0e-12 }
                          - rsi_bullish
                          - rsi_lt_70
                          - atr_volatility_ok: { min_atr_pct: 0.0005, max_atr_pct: 0.03 }
                short:
                    - all_of:
                          - ema_20_lt_50
                          - close_below_vwap_or_ma9
                          - macd_hist_lt_eps: { eps: 1.0e-12 }
                          - rsi_bearish
                          - rsi_gt_30
                          - atr_volatility_ok: { min_atr_pct: 0.0005, max_atr_pct: 0.03 }

            # -------------------------
            # 1m : TIMING / EXECUTION
            # -------------------------
            '1m':
                long:
                    - all_of:
                          - ema20_over_50_with_tolerance_moderate
                          - near_vwap: { near_vwap_tolerance: 0.0012 }   # 0.12 %
                          - close_above_vwap_or_ma9
                          - macd_hist_gt_eps: { eps: 1.0e-12 }
                          - macd_hist_increasing_n: { macd_hist_increasing_n: 1 }
                          - rsi_bullish
                          - rsi_lt_70
                          - atr_volatility_ok: { min_atr_pct: 0.00035, max_atr_pct: 0.03 }

                short:
                    - all_of:
                          - ema_20_lt_50
                          - near_vwap: { near_vwap_tolerance: 0.0012 }   # 0.12 %
                          - close_below_vwap_or_ma9
                          - macd_hist_lt_eps: { eps: 1.0e-12 }
                          - macd_hist_decreasing_n: { n: 1 }
                          - rsi_bearish
                          - rsi_gt_30
                          - atr_volatility_ok: { min_atr_pct: 0.00035, max_atr_pct: 0.03 }
